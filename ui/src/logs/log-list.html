<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<dom-module id="log-list">
    <template>
      <style>
          :host {
              overflow: hidden;
              height: 662px;
          }

          /* Let's get this party started */
          vaadin-grid .details table::-webkit-scrollbar {
              width: 6px;
              height: 6px;
          }

          /* Track */
          vaadin-grid .details table::-webkit-scrollbar-track {
              border-radius: 5px;
          }

          /* Handle */
          vaadin-grid .details table::-webkit-scrollbar-thumb {
              -webkit-border-radius: 10px;
              border-radius: 10px;
              background: rgba(0, 0, 0, 0.5);
          }
          vaadin-grid .details table::-webkit-scrollbar-thumb:window-inactive {
              background: rgba(0, 0, 0, 0.5);
          }

          vaadin-combo-box {
              padding: 8px;
          }
          .head {
              padding: 0 16px 16px 24px;
              align-items: flex-end;
          }
          vaadin-combo-box {
              padding-top: 0;
          }
          vaadin-grid {
              border-top: 1px solid #ddd;
              min-height: 788px;
              font-size: 12px;
          }

          paper-icon-button {
              width: 30px;
              height: 30px;
          }

          vaadin-grid .details {
              display: block;
              font-family: monospace;
              overflow: scroll;
              height: 266px;
              margin: 0 16px;
          }

          vaadin-grid .details table {
              position: inherit;
              padding-left: 0px;
              overflow: scroll;
              border-spacing: 0px;
          }
          vaadin-grid .details table tbody {
              border-top: 1px solid #dbdbdb;
              border-bottom: 1px solid #dbdbdb;
              margin-top: 2px;
              margin-bottom: 2px;
          }
          vaadin-grid .details table tr.keys {
              display: none;
          }
          vaadin-grid .details td.key {
              font-weight: bold;
              min-width: 155px;
              border-right: 1px solid #dbdbdb;
              padding: 3px 16px 3px 30px
          }

          vaadin-grid .details td.value {
              padding-left: 8px;
              white-space: pre-wrap;
          }

          vaadin-grid table > thead > tr > th {
              background-color: #F2F2F2 !important;
          }

          tr[odd] td {
            background-color: #fafafa;
          }
      </style>
      <paper-material>
        <div class="head layout horizontal">
          <h3 class="flex">LOGS</h3>
          <vaadin-combo-box class="flex" label="Filter logs" value="{{filterText}}" items="[[logFilterSuggestions]]" allow-custom-value></vaadin-combo-box>
        </div>
        <vaadin-grid id="grid" items="[[filteredItems]]" on-cell-click="_onCellClick">
          <vaadin-grid-column-group frozen>
            <template class="row-details">
              <div class="details">
                <table>
                  <tbody>
                    <template is="dom-repeat" items="{{item.keys}}" as="i">
                      <tr class$="[[i.key]]">
                        <td class="key">[[i.key]]</td>
                        <td class="value">[[i.value]]</td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </template>
            <vaadin-grid-column width="20px" flex="1">
              <template>
                <paper-icon-button icon="icons:arrow-drop-down" toggles active="{{expanded}}" style$="[[_computeIconStyle(expanded)]]"></paper-icon-button>
              </template>
            </vaadin-grid-column>
            <vaadin-grid-column flex="3">
              <template class="header">Time</template>
              <template>[[_computeRelativeTime(item.time)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20px" flex="1">
              <template class="header"></template>
              <template><iron-icon icon="error" hidden$=[[!item.error]]></template>
            </vaadin-grid-column>
          </vaadin-grid-column-group>

          <vaadin-grid-column flex="2">
            <template class="header">Type</template>
            <template>[[item.type]]</template>
          </vaadin-grid-column>
          <vaadin-grid-column flex="2">
            <template class="header">Action</template>
            <template>[[item.action]]</template>
          </vaadin-grid-column>
          <vaadin-grid-column flex="2">
            <template class="header">By</template>
            <template>[[item.email]]</template>
          </vaadin-grid-column>
        </vaadin-grid>
      </paper-material>
    </template>
</dom-module>

<script>
Polymer({
    is: 'log-list',

    properties: {
        items: {
            type: Array,
            value: []
        },

        filteredItems: {
            type: Array,
            computed: '_filterItems(items.*, filterMap)'
        },

        stop: {
            type: Number,
            value: 0
        },

        limit: {
            type: Number,
            value: 50
        },

        filterText: {
            type: String
        },

        resourceFilter: {
            type: Object,
            value: function() {
                return {};
            }
        },

        hasReachedEnd: false,

        filterMap: {
            type: Object,
            computed: '_computeFilterMap(filterText, resourceFilter)',
            observer: '_updateLogFilter'
        },

        logFilterSuggestions: {
            type: Array,
            value: ['type:job', 'type:request', 'type:incident', 'type:session', 'type:shell', 'error']
        },

        queryFinished: {
          type: Boolean,
          value: false
        },

        elementReady: false,

        wait: false
    },

    //listeners: { 'filter-changed': '_updateLogFilter'},

    ready: function() {
        var socket = document.querySelector('mist-socket'), that = this;
        if (!socket || !socket.get('initialized')) {
            this.async(function() {
              this.ready();
            }, 1000);
            console.debug('postpone log-list init until socket is ready');
            return
        }
        this.elementReady = true;
        this.$.grid.size = 10;
        this._updateLogFilter(this.filterMap);
        this.listen(this.querySelector('vaadin-grid-table'), 'wheel', '_onWheel');
    },

    _onWheel: function(e){
        if (this.hasReachedEnd)
            return;
        var t = this.querySelector('vaadin-grid-table');
        if (t._scrollBottom / t._scrollHeight > 0.75) {
            this._requestData();
        }
    },

    _requestData: function() {
        if (this.$.grid.loading) { // defer request if previous request pending
            if (!this.hasReachedEnd)
                this.async(function(){this._requestData}, 200);
            return;
        }
        var url = '/api/v1/logs?';

        for (f in this.filterMap)
            url += f + '=' + this.filterMap[f] + '&'

        var stop = this.items.length ? Math.floor(this.items[this.items.length-1].time) : 0;
        if (stop)
            url += 'stop=' + stop + '&'
        url += "limit=" + this.limit;

        var xhr = new XMLHttpRequest(), that = this;
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                //var scroller = that.$.grid.querySelector('vaadin-grid-table-outer-scroller'), position = scroller.scrollTop;
                if (response.length){
                    that.push.apply(that, ['items'].concat(response.map(function(i){
                        i.keys = that._computeItemKeys(i);
                        return i;
                    })));
                    if (that.items.length < that.limit && !that.hasReachedEnd)
                        that.async(function(){that._requestData()}, 100);
                } else {
                    that.hasReachedEnd = true;
                }
                that.$.grid.loading = false;
            }
        };
        this.$.grid.loading = true;
        xhr.open("GET", url, true);
        xhr.send();
    },

    _computeItemKeys: function(item){
        return Object.keys(item).map(function(k) {
          return {key: k, value: JSON.stringify(item[k])}
        });
    },

    _computeFilterMap: function(filterText, resourceFilter) {
        var ret = Object.create(resourceFilter), terms = filterText.split(' ');

        for (var i = 0; i < terms.length; i++) {
            if (terms[i].indexOf(':') > -1) {
                var kv = terms[i].split(':');
                ret[kv[0]] = kv[1];
                terms.splice(i, 1);
            } else if (terms[i] == "error") {
                ret["error"] = true;
                terms.splice(i, 1);
            }
        }

        ret['_'] = terms.join(' ').trim();
        console.debug('grid filterMap computed', ret);
        return ret;
    },

    _computeRelativeTime: function(timestamp) {
        return moment(timestamp * 1000).fromNow();
    },

    _getItemValue: function(item, key) {
        return item[key];
    },

    eventReceived: function(entry) {
        entry.keys = this._computeItemKeys(entry);
        this.unshift('items', entry);
    },

    _computeIconStyle: function(expanded) {
        if (!expanded) return "transform: rotate(270deg)";
    },

    _onCellClick: function(e) {
        var item = e.detail.model.item;
        console.warn('cellClick', e);
        /*
        if (this.$.grid.expandedItems.indexOf(item) == -1) {
            console.warn('expand', item);
            item.keys = Object.keys(item).forEach(function(k) {
                return {key: k, value: item[k]}
            });
            this.$.grid.expandItem(item);
        } else {
            console.warn('collapse', item, e);
            //this.$.grid.collapseItem(item);
        }*/
    },

    _onDetailsTap: function(e) {
        console.log('tap', e);
    },

    _updateColumns: function(items) {
        var Set = swiftSet.Set;
        var allKeys = new Set(), allTypes = new Set(), allActions = new Set();
        for (var i=0;i<items.length;i++) {
            allKeys.addItems(Object.keys(items[i]));
            allTypes.add('type:' + items[i].type);
            allActions.add('action:' + items[i].action);
        }

        var existingColumns = new Set();
        for (var i=0;i<this.$.grid.columns.length;i++) {
            existingColumns.add(this.$.grid.columns[i].name);
        }

        var keyItems = allKeys.items()
        for (var i=0;i<keyItems.length;i++)
            if (!existingColumns.has(keyItems[i]))
                this.$.grid.addColumn({name: keyItems[i], hidden: true, hidable: true})

        var logFilterSuggestions = new Set(this.get('logFilterSuggestions')).union(allActions);

        this.set('logFilterSuggestions', logFilterSuggestions);
    },

    _updateLogFilter: function(data) {
        if (!this.elementReady) {
            console.debug('grid not yet ready');
            return;
        }
        console.debug('grid _updateLogFilter', data, this.filterText);
        this.set('items', []);
        this.hasReachedEnd = false;
        this.$.grid.$.scroller._resetScrollPosition(0);
        this._requestData();
    },

    _filterItems: function(items, filterMap) {
        var ret = this.items.filter(function(item){
            var terms = filterMap['_'] ? filterMap['_'].split(' ') : [];
            for (var i = 0; i < terms.length; i++)
                if (terms[i].length && JSON.stringify(item).indexOf(terms[i]) == -1)
                    return false;
            return true;
        });
        return ret;
    },
});

var TIME_MAP = {
    SECOND: 1000,
    MINUTE: 60 * 1000,
    HOUR: 60 * 60 * 1000,
    DAY: 24 * 60 * 60 * 1000,
    WEEK: 7 * 24 * 60 * 60 * 1000,
    MONTH: 30 * 24 * 60 * 60 * 1000,
    YEAR: 12 * 30 * 24 * 60 * 60 * 1000,
};

</script>
