<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<dom-module id="rule-identifier">
	<template>
		<style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="shared-styles">
        :host {
        	display: inline-block;
        }
        paper-dropdown-menu {
            width: 150px;
            --paper-dropdown-menu-input: {
                text-transform: uppercase;
            }
            --paper-input-container-underline: {
                /*display: none;*/
                opacity: 0.32;
            };
        }
        paper-dropdown-menu ::content div.floated-label-placeholder {
            margin-top: -12px;
        }
        paper-dropdown-menu.short {
            width: 80px;
            margin-right: 16px;
        }
        paper-input ::content div.floated-label-placeholder{
            display: none;
        }
        paper-input {
            vertical-align: baseline;
        }
        paper-input ::content paper-input-container {
            padding: 0;
        }
        .flex {
            display: inline-flex;
        }
        .tag {
        	display: inline-block;
        	vertical-align: middle;
        }
        paper-input {
        	--paper-input-container-underline {
        		opacity: 0.32;
        	}
        }
        </style>
        <paper-dropdown-menu class="short" no-animations>
        	<paper-listbox class="dropdown-content" selected="[[selectedIndetifierType]]">
                <paper-item class="indettype">ID</paper-item>
                <paper-item class="indettype">TAGS</paper-item>
          	</paper-listbox>
        </paper-dropdown-menu>

        <span hidden$="[[!_ruleHasTags(rule)]]">
            <template is="dom-repeat" items="[[_computeRTags(rule.rtags)]]" as="tag">
                <span class="tag" class="flex">[[tag]]</span>
                <!-- <paper-input class="flex" value="[[tag]]"></paper-input> -->
            </template>
        </span>

        <span hidden$="[[!showInputField]]">
        	<paper-input class="flex" value=""></paper-input>
        </span>

        <span hidden$="[[!_ruleHasId(rule)]]">
            <paper-input value="[[rule.rid]]" class="flex"></paper-input>
        </span>

        <span hidden$="[[!showDropDown]]">
            <paper-dropdown-menu no-animations>
                <paper-listbox class="dropdown-content" selected="[[selectedResource]]" >
                    <template is="dom-repeat" items="[[resourceDropDown]]" as="resource">
                        <paper-item class="rid" value="[[resource.id]]">[[resource.title]] [[resource.name]]</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <!-- resource info -->
            <!-- <span class="sub" hidden$="[[!_computeLink(rule.rtype,rule.rid)]]">[[_computeLink(rule.rtype,rule.rid)]]</span> -->
            <!-- <a class="sub" href$="/[[rule.rtype]]s/[[rule.rid]]" class="blue-link regular" hidden$="[[_computeLink(rule.rtype,rule.rid)]]"> -<iron-icon icon="link"></iron-icon>[[rule.rid]]</a> -->
            
            <!-- <span class="tag" class="flex">[[tag]]</span> -->
            <!-- <paper-input class="flex" value="[[tag]]"></paper-input> -->
        </span>
        <span>
            <!-- <vaadin-combo-box class="flex" items="[[_computeRuleCombo(rule.rtype)]]" allow-custom-value on-value-change="_updateRuleIdentifier"></vaadin-combo-box> -->
        </span>
    </template>
 </dom-module>
 <script>
 	(function() {
        'use strict';

        Polymer({
            is: 'rule-identifier',
            properties: {
            	model: Object,
            	rule: Object,
            	selectedIndetifierType: {
            		type: Number,
            		computed: "_computeSelectedIdentifierType(rule)"
            	},
            	resourceDropDown: {
            		type: Array,
            		computed: "_computeRuleDD(rule, model)"
            	},
            	selectedResource: {
            		computed: "_computeSelectedRuleDD(rule, model)"
            	},
            	showDropDown: {
            		type: Boolean,
            		value: false
            	},
            	showInputField: {
            		type: Boolean,
            		value: false
            	},
            	ruleHasTags: {
            		type: Boolean,
            		value: false,
            		computed: "_ruleHasTags(rule)"
            	}
            },
            listeners: {
            	'iron-select': '_updateIdentifier'
            },
            ready: function(){

            },
            _updateIdentifier: function(e){
                // case of changing indettype 
                if (e.detail.item.attributes.class.nodeValue.indexOf('indettype') > -1){
                    var indettype = e.detail.item.textContent.trim().toLowerCase();
                    if (indettype == 'tags') {
                        this.set('showDropDown', false);
                        this.set('showInputField', true);
                    }
                    else {
                        var id = this.rule.rid ? this.rule.rid :'select resource';
                     	this.set('showDropDown', true); 
                     	this.set('showInputField', false);
                    }
                    
                }
            },
            _ruleHasTags: function(rule){
            	return Object.keys(rule.rtags).length > 0 ? true : false;
            },
            _ruleHasId: function(rule){
                return rule.rid.length > 0 ? true : false;
            },
            _computeRTags: function(tags){
            	var arrTags = Object.keys(tags); 
                for (var i=0; i < arrTags.length; i++) {
                	var t = arrTags[i];
                	if (tags[t] != null) {
                		arrTags[i] = arrTags[i]+'='+tags[t];
                	}
                }
                return arrTags;
            },
            _computeLink: function(type, id){
            	if (type && id && type != "cloud") {
            		return false;
            	}
            	else if (type == "cloud" && id){
            		return this.model.clouds[id].title;
            	}
                else if (type == "cloud" && !id){
                    return 'all clouds';
                }
            },
            _computeResourceName: function(type, id){
                if (type && id) {                    
                    var mod =  this.model[type+'s'];
                    return mod[id].name;
                }
            },
            _computeSelectedIdentifierType: function(rule){
                if (rule.rid) {
                    return 0;
                }
                else {
                    return Object.keys(this.rule.rtags).length > 0 ? 1 : null;
                }
            },
            _computeRuleDD: function(rule, model){
                console.log(rule.rtype, model);
                if (rule.rtype && rule.rtype!='' && this.model[rule.rtype+'sArray'] && this.model[rule.rtype+'sArray'].length > 0) {
                    return this.model[rule.rtype+'sArray'];
                }
                else {
                    return [{name:'no '+rule.rtype+'s found'}];
                }
            },
            _computeRuleCombo: function(rtype){
                if (rtype && this.model[rtype+'sArray'].length > 0) {
                    var ar = [];
                    for (var i=0; i<this.model[rtype+'sArray'].length; i++){
                        var name = this.model[rtype+'sArray'][i].title ? this.model[rtype+'sArray'][i].title : this.model[rtype+'sArray'][i].name;
                        ar.push(name);
                    }
                    return ar;
                }
                else {
                    return [{name:'no '+rtype+'s found'}];
                }
            },
            _computeSelectedRuleDD: function(rule, model){
                if (rule.rid && rule.rid.length > 0){
                    var i;
                    var obj = this.model[rule.rtype+'sArray'].find(function(r, index){
                        i = index;
                        return r.id == rule.rid;
                    });
                    return i;
                }
                else {
                    return null;
                }
            }
        });
    })();
 </script>