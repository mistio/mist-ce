<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="rule-identifier">
	<template>
		<style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="shared-styles">
        :host {
        	display: inline-block;
        }
        paper-dropdown-menu {
            width: 150px;
            --paper-dropdown-menu-input: {
                text-transform: uppercase;
            }
            --paper-input-container-underline: {
                /*display: none;*/
                opacity: 0.32;
            };
        }
        paper-dropdown-menu ::content div.floated-label-placeholder {
            margin-top: -12px;
        }
        paper-dropdown-menu.short {
            width: 80px;
            margin-right: 16px;
        }
        paper-input ::content div.floated-label-placeholder{
            display: none;
        }
        paper-input {
            vertical-align: baseline;
        }
        paper-input ::content paper-input-container {
            padding: 0;
        }
        .flex {
            display: inline-flex;
        }
        .tag {
        	display: inline-block;
        	vertical-align: middle;
        }
        paper-input {
        	width: 150px;
        	--paper-input-container-underline {
        		opacity: 0.32;
        	}
        }
        .tag iron-icon {
        	color: #fff;
        	width: 13px;
        	height: 13px;
        	cursor: pointer;
        }
        iron-icon.edit {
        	color: inherit;
        	padding: 8px;
        	opacity: 0.32
        }
        iron-icon
        </style>
        <paper-dropdown-menu class="short" no-animations>
        	<paper-listbox class="dropdown-content" selected="[[selectedIndetifierType]]">
                <paper-item class="indettype">ID</paper-item>
                <paper-item class="indettype">TAGS</paper-item>
          	</paper-listbox>
        </paper-dropdown-menu>

        <span hidden$="[[!_ruleHasTags(rule)]]">
            <template is="dom-repeat" items="[[tags]]" as="tag">
            	<span class="tag" class="flex" hidden$="[[showEdit]]">[[tag]] <iron-icon id$="tag-[[index]]" icon="close" on-tap="_deleteTag"></iron-icon></span>
            </template>
        </span>
        <span hidden$="[[!showDropDown]]">
            <paper-dropdown-menu no-animations hidden$="[[showTags]]">>
                <paper-listbox class="dropdown-content" selected="[[selectedResource]]" >
                    <template is="dom-repeat" items="[[resourceDropDown]]" as="resource">
                        <paper-item class="rid" value="[[resource.id]]">[[resource.title]] [[resource.name]]</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
        </span>
        <span hidden$="[[!showTags]]">
	        <paper-input class="flex" value$="[[tagString]]" hidden$="[[!showEdit]]"></paper-input>
	        <iron-icon class="edit" icon="editor:mode-edit" on-tap="_toggleShowEdit"></iron-icon>
        </span>
    </template>
 </dom-module>
 <script>
 	(function() {
        'use strict';

        Polymer({
            is: 'rule-identifier',
            properties: {
            	model: Object,
            	rule: {
            		type: Object,
            		notify: true
            	},
            	index: Number,
            	rtype: String,
            	selectedIndetifierType: {
            		type: Number,
            		computed: "_computeSelectedIdentifierType(rule)"
            	},
            	resourceDropDown: {
            		type: Array,
            		computed: "_computeRuleDD(rule, rtype, model)"
            	},
            	selectedResource: {
            		type: Number,
            		computed: "_computeSelectedRuleDD(rule, model)"
            	},
            	showDropDown: {
            		type: Boolean,
            		value: false
            	},
            	showTags: {
            		type: Boolean,
            		value: false
            	},
            	ruleHasTags: {
            		type: Boolean,
            		value: false,
            		computed: "_ruleHasTags(rule)"
            	},
            	showEdit: {
            		type: Boolean,
            		value: false
            	},
            	tagString: {
            		type: String,
            		computed: "_computeTagString(rule, rule.rtags)"
            	},
            	tags: {
            		type: Array,
            		computed: '_computeRTags(rule.rtags)'
            	}
            },
            listeners: {
            	'iron-select': '_updateIdentifier'
            },
            ready: function(){

            },
            _computeTagString: function(rule, rtags){
            	return this._computeRTags(rtags).join(', ');
            },
            _updateIdentifier: function(e){
                // case of changing indettype 
                if (e.detail.item.attributes.class.nodeValue.indexOf('indettype') > -1){
                    var indettype = e.detail.item.textContent.trim().toLowerCase();
                    if (indettype == 'tags') {
                        this.set('showDropDown', false);
                        this.set('showTags', true);
                    }
                    else {
                        var id = this.rule.rid ? this.rule.rid :'select resource';
                     	this.set('showDropDown', true); 
                     	this.set('showTags', false);
                    }
                    
                }
            },
            _ruleHasTags: function(rule){
            	return Object.keys(rule.rtags).length > 0 ? true : false;
            },
            _ruleHasId: function(rule){
                return rule.rid.length > 0 ? true : false;
            },
            _computeRTags: function(tags){
            	var arrTags = Object.keys(tags); 
                for (var i=0; i < arrTags.length; i++) {
                	var t = arrTags[i];
                	if (tags[t] != null) {
                		arrTags[i] = arrTags[i]+'='+tags[t];
                	}
                }
                return arrTags;
            },
            _computeLink: function(type, id){
            	if (type && id && type != "cloud") {
            		return false;
            	}
            	else if (type == "cloud" && id){
            		return this.model.clouds[id].title;
            	}
                else if (type == "cloud" && !id){
                    return 'all clouds';
                }
            },
            _computeResourceName: function(type, id){
                if (type && id) {                    
                    var mod =  this.model[type+'s'];
                    return mod[id].name;
                }
            },
            _computeSelectedIdentifierType: function(rule){
                if (rule.rid) {
                    return 0;
                }
                else {
                    return Object.keys(this.rule.rtags).length > 0 ? 1 : null;
                }
            },
            _computeRuleDD: function(rule, rtype, model){
                if (rtype && rtype!='' && this.model[rtype+'sArray'] && this.model[rtype+'sArray'].length > 0) {
                    return this.model[rtype+'sArray'];
                }
                else {
                    return [{name:'no '+rtype+'s found'}];
                }
            },
            _computeRuleCombo: function(rtype){
                if (rtype && this.model[rtype+'sArray'].length > 0) {
                    var ar = [];
                    for (var i=0; i<this.model[rtype+'sArray'].length; i++){
                        var name = this.model[rtype+'sArray'][i].title ? this.model[rtype+'sArray'][i].title : this.model[rtype+'sArray'][i].name;
                        ar.push(name);
                    }
                    return ar;
                }
                else {
                    return [{name:'no '+rtype+'s found'}];
                }
            },
            _computeSelectedRuleDD: function(rule, model){
                if (rule.rid && rule.rid.length > 0){
                    var i;
                    var obj = this.model[rule.rtype+'sArray'].find(function(r, index){
                        i = index;
                        return r.id == rule.rid;
                    });
                    return i;
                }
                else {
                    return null;
                }
            },
            _toggleShowEdit: function(){
            	this.set('showEdit', !this.showEdit);
            },
            _deleteTag: function(e){
            	var tag = e.detail.sourceEvent.path[1].textContent.split('=')[0].trim();
            	var index = e.detail.sourceEvent.path[0].id.split('-')[1];
            	console.log(e, tag, index);
            	this.fire('delete-rtag', {'index': this.index, 'tag': tag});
            }
        });
    })();
 </script>