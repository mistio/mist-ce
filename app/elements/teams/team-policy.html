<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/Sortable/Sortable.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="rule-identifier.html">
<dom-module id="team-policy">
	<template>
		<style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="shared-styles">
        :host {
            display: block;
            padding-bottom: 16px; 
        }
        .rule span {
        	padding-right: 8px;
        }
        .uppercase {
        	text-transform: uppercase;
        }
        #rules,
        .rules {
        	display: table;
            width: 100%;
            border-collapse: collapse;
        	padding: 16px;
        }
        .rule {
        	display: table-row;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        #rules .rule:nth-of-type(2n+1) {
            background-color: #f6f6f6;
        }
        #rules .rule .index {
            cursor: move;
        }
        .rule.head {
            font-size: 0.9em;
            font-weight: 500;
        }
        .rule.head .index{
            cursor: default;
        }
        .rule > span {
        	display: table-cell;
            border-left: 1px solid #eee;
        	padding: 8px;
        }        
        .rule .tag {
        	display: inline-block;
        	vertical-align: middle;
        }
        .operator-text {
            padding-right: 8px;
        }
        .sub {
        	font-size: 0.9em;
        	color: rgba(0,0,0,0.54); 
            font-weight: 300;
        }
        .default {
            padding: 8px 8px 8px 16px;
            font-size: 16px;
        }
        .index {
            text-align: center;
        }
        .add {
            border-bottom: 1px solid #eee;
            width: 100%;
            display: block;
            cursor: pointer;
        }
        .add .index {
            padding: 12px;
        }
        .bottom-actions {
            display: flex;
        }
        paper-toggle-button.operator {
            display: inline-block;
            vertical-align: middle;
            --paper-toggle-button-checked-bar-color:  var(--green-color);
            --paper-toggle-button-checked-button-color:  var(--green-color);
            --paper-toggle-button-checked-ink-color: var(--green-color);
            --paper-toggle-button-unchecked-bar-color:  var(--red-color);
            --paper-toggle-button-unchecked-button-color:  var(--red-color);
            --paper-toggle-button-unchecked-ink-color: var(--red-color);
        }
        #changeRecord {
            padding: 8px 24px;
            background-color: #ddd;
        }
        #changeRecord > p {
            font-size: 0.8em;
            color: rgba(0,0,0,0.54);
        }
        .delete {
            opacity: 0.54;
            cursor: pointer;
        }
        .progress {
            margin: 0;
            width: 100%;
            display: block;
        }
        paper-progress {
            width: 100%;
        }
        paper-progress#progresserror ::content #primaryProgress {
            background-color: var(--red-color);
        }
        .errormsg-container {
            color: var(--red-color);
            padding-left: 16px;
            padding-right: 16px;
        }
        .errormsg-container iron-icon {
            color: inherit;
        }
        .head iron-icon {
            opacity: 0.32;
            width: 20px;
            height: 20px;
        }
        paper-tooltip ::content #tooltip{
            font-size: 12px;
        }
        .pull-right {
            float: right;
        }
        paper-dropdown-menu {
            width: 150px;
            --paper-dropdown-menu-input: {
                text-transform: uppercase;
            }
            --paper-input-container-underline: {
                /*display: none;*/
                opacity: 0.32;
            };
        }
        paper-dropdown-menu ::content div.floated-label-placeholder {
            margin-top: -12px;
        }
        paper-dropdown-menu.short {
            /*width: 80px;*/
            margin-right: 16px;
        }
        paper-input ::content div.floated-label-placeholder{
            display: none;
        }
        paper-input {
            vertical-align: baseline;
        }
        paper-input ::content paper-input-container {
            padding: 0;
        }
        .notice {
            font-size: 0.9em;
            opacity: 0.54;
            padding-left: 40px;
        }
        .notice iron-icon {
            opacity: 0.6;
        }
        @media (max-width: 1380px) { 
            .rule > span {
                vertical-align: top;
            }
            .narrow-hide {
                display: none;
            }
            paper-toggle-button {
                display: block !important;
            }
        }
        </style>
        <div id="rules">
            <div class="rule head">
                <span class="index">ord.</span>
                <span>operator</span>
                <span>resource</span>
                <span>action</span>
                <span>condition <iron-icon id="condition" icon="icons:help"></iron-icon>
                   <paper-tooltip for="condition" position="top">
                        A conditional rule will apply to either a specified resource, <br/>
                        or resources that have ALL specified tags. <br/>
                        Tags must be comma separated. </paper-tooltip>
                </span>
                <span></span>
            </div>
	        <template is="dom-repeat" items="[[rules]]" as="rule" id="rulesrepeat">
	            <div id="[[index]]" class$="rule ruleitem-[[index]]">
	            	<span class="index">
	            		[[index]]. 
	            	</span>
	            	<span class="operator">
                        <paper-toggle-button id$="index-[[index]]" class="operator" checked$="[[_computeToggle(rule.operator)]]" on-tap="_changeOperator" data-attr="[[index]]"></paper-toggle-button>
	                	<span id$="index-[[index]]" class="operator-text">[[rule.operator]] </span>
                    </span>
                    <span class="resource">
                        <span class="narrow-hide">
                            on 
                        </span>
                        <span class="uppercase">
                            <paper-dropdown-menu no-animations data-attr="[[index]]">
                              <paper-listbox class="dropdown-content" selected="[[_computeSelectedType(index, rule.rtype)]]" data-attr="[[index]]">
                                <template is="dom-repeat" items="[[resources]]">
                                    <paper-item value="[[item]]" class="rtype">[[item]]</paper-item>    
                                </template>
                              </paper-listbox>
                            </paper-dropdown-menu>
                        </span>
                    </span>
	                <span class="action">
                        <span class="uppercase">
                            <paper-dropdown-menu no-animations data-attr="[[index]]">
                              <paper-listbox class="dropdown-content" selected="[[_computeSelectedAction(index, rule.rtype, rule.action)]]" data-attr="[[index]]">
                                <template is="dom-repeat" items="[[_computeActions(index, rule.rtype)]]">
                                    <paper-item value="[[item]]" class="raction">[[pretify(item)]]</paper-item>    
                                </template>
                              </paper-listbox>
                            </paper-dropdown-menu>
		                </span>
	                </span>
	                <span class="identifier">
                        <rule-identifier model="[[model]]" rule="[[rule]]" rtype="[[rule.rtype]]" rtags="[[rule.rtags]]" index="[[index]]" rid="[[rule.rid]]"></rule-identifier>
                    </span>
                    <span class="delete">
                        <iron-icon id$="delete-[[index]]" icon="close" on-tap="_deleteRule" data-attr="[[index]]"></iron-icon>
                    </span>
	            </div>
	        </template>            
        </div>
        <div class="rules">
            <div class="rule add">
                <span class="index">
                    <iron-icon icon="icons:add-circle" on-tap="_addRule"></iron-icon> <span on-tap="_addRule">Add a new rule</span>
                </span>
            </div>
            <paper-item class="default">
                <paper-toggle-button id="defaultoperator" class="operator" checked$="[[_computeToggle(defaultOperator)]]" [[_computeDisabled(team)]] on-tap="_changeOperator"></paper-toggle-button>
                <span id="defaultoperator" class="operator-text">[[defaultOperator]] </span> 
                every other action ON any other resource
                <span class="notice" hidden$="[[!_computeToggle(defaultOperator)]]"> 
                    <iron-icon icon="icons:warning"></iron-icon> This option will allow EVERY action on any resource not specified in the policy above.
                </span>
            </paper-item>
        </div>
        <div id="changeRecord" hidden>
            <h4>Changes: </h4>
            <p>
                Add rule 4.<br/>
                Change ALLOW to DENY in rule 5.<br/>
            </p>
        </div>

        <div class="progress">
            <paper-progress id="progress" indeterminate hidden$="[[!sendingData]]"></paper-progress>
            <paper-progress id="progresserror" value="100" hidden$="[[!formError]]"></paper-progress>
            <p class="errormsg-container" hidden$="[[!formError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="errormsg"></span></p>
        </div>

        <div class="clearfix bottom-actions xs12">
            <paper-button id="appformsubmit" class="submit-btn pull-left blue" disabled$="[[!formReady]]" raised on-tap="_submitForm">Save policy</paper-button>
            <paper-button class="submit-btn pull-right" on-tap="_resetForm" disabled$="[[!formReady]]"><iron-icon icon="icons:refresh"></iron-icon>Reset Policy</paper-button>
        </div>
        <iron-ajax id="postPolicy" url="/api/v1/org/[[model.org.id]]/teams/[[team.id]]/policy" contentType="application/json" handle-as="xml" method="PUT" on-request="_handlePostPolicy" on-response="_handleResponse" on-error="_handleError"></iron-ajax>

        <paper-toast></paper-toast>
    </template>
</dom-module>
<script type="text/javascript" src="../../bower_components/swiftSet/swiftSet.js"></script>
<script>
	(function() {
        'use strict';

        Polymer({
            is: 'team-policy',
            properties: {
            	team: Object,
            	model: Object,
                rules: {
                    type: Array,
                    value: []
                },
                defaultOperator: {
                    type: String,
                    value: ''
                },
                formReady: {
                    type: Boolean,
                    value: false
                },
                hasChanges: {
                    type: Boolean,
                    value: false  
                },
                changes: {
                    type: Array
                },
                sendingData: {
                    type: Boolean,
                    value: false  
                },
                formError: {
                    type: Boolean,
                    value: false  
                },
                newOrder: {
                    type: Array,
                    value: []
                },
                resources: {
                    type: Array,
                    value: [
                        "ALL",
                        "CLOUD",
                        "MACHINE",
                        "SCRIPT",
                        "KEY",
                        "TEMPLATE",
                        "STACK",
                        "TEAM"
                    ]
                },
                commonPermissions: {
                    type: Array,
                    computed: '_computeCommonPermissions(model)'
                }
            },
            observers: [
                // removed model.teamsArray from dep, due to reseting rules on connection changes
                '_teamChanged(team, team.policy.rules)'
            ],
            listeners: {
                'end': '_orderChanged',
                'iron-select': '_updateRule',
                'delete-rtag': '_deleteRtag',
                'update-rtags': '_updateRtags',
                'update-rid': '_updateRid'

            },            
            attached: function(){
                var el = document.getElementById('rules');
                var sortable = Sortable.create(el, {
                    filter: '.head'
                });

            },
            _computeCommonPermissions: function(model){
                var commonPermissions = this.model.permissions['cloud'],
                    that = this;
                ['machine', 'key', 'script', 'template', 'stack', 'team'].forEach(function(t){
                    var s = new swiftSet.Set(commonPermissions);
                    commonPermissions = s.intersection(that.model.permissions[t]);
                });
                return commonPermissions;
            },
            _orderChanged: function(e){
                var reorderElements = this.$.rules.children;
                this.newOrder = [];
                [].forEach.call(reorderElements, function(el){
                    el.classList.forEach(function(c){
                        if(c.indexOf('ruleitem') > -1){
                            var ind = parseInt(c.split('-')[1]);                            
                            this.push('newOrder',this.rules[ind]);
                        }
                    },this)
                }, this);

                this.ruleHasChanges();
            },
            _teamChanged: function(team, rules, teams){
                // copy default operator to a new string
                var initialOp = this.team.policy.operator;
                var newString = initialOp.slice(0);
                this.set("defaultOperator", newString);

                // copy the rules array to a new array by .slice(0)
                // var initial = this.team.policy.rules;
                // var newArr = initial.slice(0);
                // clean copy of items
                var newArr = [];
                this.team.policy.rules.forEach(function(rule, i){
                    var cleanCopy = {};
                    for(var p in rule) {
                        if (typeof rule[p] == 'string'){
                            var initial = rule[p];
                            var str = initial.slice(0);
                            cleanCopy[p] = str;
                        }
                        //case of rule tags
                        else if (typeof rule[p] == 'object') {
                            var obj = {};
                            for(var q in rule[p]) {
                                var initialq = q;
                                // var key = initial.slice(0);
                                var val = null;
                                if (rule[p][q] != null){
                                    var initialv = rule[p][q];
                                        val = initialv.slice(0);
                                }
                                obj[initialq] = val;
                            }
                            cleanCopy[p] = obj;
                        }
                    }
                    newArr[i] = cleanCopy;
                });
                var cleanCopyRules = newArr.slice(0);
                this.set("rules", cleanCopyRules);

                //initialize new order
                this.set('newOrder',[])
                for (var i=0; i<this.team.policy.rules.length; i++){
                     this.push('newOrder', this.rules[i])
                }
            },            
            _computeToggle: function(operator) {
                return operator == 'ALLOW'? true : false;
            },
            _computeDisabled: function(team) {
                return team.name == 'Owners'? 'disabled' : '';
            },
            _updateRule: function(e){
                //get rule index
                var ind = e.target.dataAttr;
                //case of editing rtype
                if (e.detail.item.attributes.class.nodeValue.indexOf('rtype') > -1){
                    var rtype = e.detail.item.textContent.trim();
                    if (rtype == 'ALL') {
                        rtype = '';
                    }
                    this.set('rules.#'+ind+'.rtype', rtype.toLowerCase());
                }
                //case of editing rule action
                else if (e.detail.item.attributes.class.nodeValue.indexOf('raction') > -1){
                    var raction = e.detail.item.textContent.trim().replace(' ','_').toLowerCase();
                    if (raction == 'all') {
                        raction = '';
                    }
                    this.set('rules.#'+ind+'.action', raction);
                }

                this.ruleHasChanges();
            },
            _deleteRtag: function(e){
                var ind = e.detail.index,
                    tag = e.detail.tag;
                //clean copy rules
                var rtags = {};
                for (var p in this.rules[ind].rtags){
                    if (this.rules[ind].rtags[p] && this.rules[ind].rtags[p] != null)
                        var copy = this.rules[ind].rtags[p].slice(0);
                    else {
                        copy = null;
                    }
                    rtags[p] = copy;
                }
                delete rtags[tag];
                this.set('rules.#'+ind+'.rtags', rtags);
                
                this.ruleHasChanges();
            },
            _updateRtags: function(e){
                var ind = e.detail.index,
                    rtags = e.detail.rtags;
                this.set('rules.#'+ind+'.rid', '');
                this.set('rules.#'+ind+'.rtags', rtags);
                this.ruleHasChanges();
            },
            _updateRid: function(e){
                var ind = e.detail.index,
                    rid = e.detail.rid;
                this.set('rules.#'+ind+'.rid', rid);
                this.set('rules.#'+ind+'.rtags', {});
                this.ruleHasChanges();
            },
            _addRule: function(e){
                var emptyRuleObj = {
                    action: '',
                    operator: 'DENY',
                    rid: '',
                    rtags: {},
                    rtype: ''
                };
                this.push('rules', emptyRuleObj);
                this.set('formReady', true);
                this.push('newOrder', emptyRuleObj)

                this.ruleHasChanges();
            },
            _deleteRule: function(e){
                var index = e.target.dataAttr;
                this.splice('rules',index,1);
                this.set('formReady', true);
                this.splice('newOrder', index, 1)

                this.ruleHasChanges();
            },
            _changeOperator: function(event){
                var e = Polymer.dom(event);
                var path = e.path;
                var index = e.localTarget.getAttribute('id').split('-')[1];
                var newOp = e.localTarget.attributes.checked ? 'ALLOW' : "DENY";
                if (index) {
                    this.set('rules.#'+index+'.operator', newOp);
                }
                else {
                    this.set('defaultOperator', newOp);
                }
                this.ruleHasChanges();
                console.log('_changeOperator',e);
            },
            _resetForm: function(){
                // var initial = this.team.policy.rules;
                // var newArr = initial.slice(0);
                // this.set("rules", newArr);
                var newArr = [];
                this.team.policy.rules.forEach(function(rule, i){
                    var cleanCopy = {};
                    for(var p in rule) {
                        if (typeof rule[p] == 'string'){
                            var initial = rule[p];
                            var str = initial.slice(0);
                            cleanCopy[p] = str;
                        }
                        //case of rule tags
                        else if (typeof rule[p] == 'object') {
                            var obj = {};
                            for(var q in rule[p]) {
                                var initialq = q;
                                // var key = initial.slice(0);
                                var val = null;
                                if (rule[p][q] != null){
                                    var initialv = rule[p][q];
                                        val = initialv.slice(0);
                                }
                                obj[initialq] = val;
                            }
                            cleanCopy[p] = obj;
                        }
                    }
                    newArr[i] = cleanCopy;
                });
                var cleanCopyRules = newArr.slice(0);
                this.set("rules", cleanCopyRules);

                for (var i = 0; i < newArr.length; i++) {
                    this.set('rules.#'+i+'.operator', newArr[i].operator);
                }

                var initialOp = this.team.policy.operator;
                var newString = initialOp.slice(0);
                this.set("defaultOperator", newString);

                this.set('formReady', false);
            },
            _submitForm: function(){            
                var policy = {};
                policy.rules = this.newOrder;

                policy.operator = this.defaultOperator;
                this.$.postPolicy.headers["Content-Type"] = 'application/json';
                this.$.postPolicy.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.postPolicy.body = {'policy': policy};
                this.$.postPolicy.generateRequest();

                this.set('sendingData', true);
                this.set('formReady', false);              
            },
            _handleResponse: function(e){
                var toast = this.querySelector('paper-toast');
                    toast.text = 'Team policy updated successfully.';
                    toast.show();
                this.set('sendingData', false);
                this.set('formReady', false);
            },
            _handleError: function(e,d) {
                this.set('sendingData', false);
                this.set('formError', true);
                this.$.errormsg.textContent = e.detail.request.xhr.responseText;
                this.set('formReady', true);
            },
            _computeSelectedType(index,type){
                //index of type in resources list
                var typeIndex = this.resources.indexOf(type.toUpperCase());
                return typeIndex > -1 ? typeIndex : 0;
            },
            _computeActions: function(index, rtype){
                var type = rtype.toLowerCase();

                if (type != ''){
                    return ['all'].concat(this.model.permissions[type]);
                }
                else {                    
                    return ['all'].concat(this.commonPermissions);
                }
            },
            _computeSelectedAction: function(index, rtype, raction){
                var actionIndex = 0;
                var type = rtype.toLowerCase();
                var action = raction.toLowerCase();

                if (type && action != ''){
                    actionIndex = this.model.permissions[type.toLowerCase()].indexOf(action);                
                }
                else {
                    actionIndex = this.commonPermissions.indexOf(action);
                }   
                // add one to include concatenated 'all' action
                return actionIndex > -1 ? actionIndex+1 : 0;
            },
            pretify: function(item){
                return item.replace('_',' ').toUpperCase();
            },
            ruleHasChanges: function(){
                if(this.formError){
                    this.set('formError', false);
                }
                this.set('formReady', true);

                console.log(this.rules[0], this.team.policy.rules[0] );
            }
            
        });
    })();
</script>