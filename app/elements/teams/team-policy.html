<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/Sortable/Sortable.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<dom-module id="team-policy">
	<template>
		<style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="shared-styles">
        :host {
            display: block;
            padding-bottom: 16px; 
        }
        .rule span {
        	padding-right: 8px;
        }
        .uppercase {
        	text-transform: uppercase;
        }
        #rules,
        .rules {
        	display: table;
            width: 100%;
            border-collapse: collapse;
        	padding: 16px;
        }
        .rule {
        	display: table-row;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        #rules .rule:nth-of-type(2n+1) {
            background-color: #f6f6f6;
        }
        #rules .rule .index {
            cursor: move;
        }
        .rule.head {
            font-size: 0.9em;
            font-weight: 500;
        }
        .rule.head .index{
            cursor: default;
        }
        .rule > span {
        	display: table-cell;
            border-left: 1px solid #eee;
        	padding: 8px;
        }
        .rule .tag {
        	display: inline-block;
        	vertical-align: bottom;
        }
        .operator-text {
            padding-right: 8px;
        }
        .sub {
        	font-size: 0.9em;
        	color: rgba(0,0,0,0.54); 
            font-weight: 300;
        }
        .default {
            padding: 8px 8px 8px 16px;
            font-size: 16px;
        }
        .index {
            text-align: center;
        }
        .add {
            border-bottom: 1px solid #eee;
            width: 100%;
            display: block;
            cursor: pointer;
        }
        .add .index {
            padding: 12px;
        }
        .bottom-actions {
            display: flex;
        }
        paper-toggle-button.operator {
            display: inline-block;
            vertical-align: middle;
            --paper-toggle-button-checked-bar-color:  var(--green-color);
            --paper-toggle-button-checked-button-color:  var(--green-color);
            --paper-toggle-button-checked-ink-color: var(--green-color);
            --paper-toggle-button-unchecked-bar-color:  var(--red-color);
            --paper-toggle-button-unchecked-button-color:  var(--red-color);
            --paper-toggle-button-unchecked-ink-color: var(--red-color);
        }
        #changeRecord {
            padding: 8px 24px;
            background-color: #ddd;
        }
        #changeRecord > p {
            font-size: 0.8em;
            color: rgba(0,0,0,0.54);
        }
        .delete {
            opacity: 0.54;
            cursor: pointer;
        }
        </style>
        <div id="rules">
            <div class="rule head">
                <span class="index">ord.</span>
                <span>operator</span>
                <span>resource</span>
                <span>action</span>
                <span>resource identifier</span>
                <span></span>
            </div>
	        <template is="dom-repeat" items="[[team.policy.rules]]" as="rule">
	            <div class$="rule [[index]]">
	            	<span class="index">
	            		[[index]]. 
	            	</span>
	            	<span>
                        <paper-toggle-button id$="index-[[index]]" class="operator" checked$="[[_computeToggle(rule.operator)]]" on-tap="_changeOperator"></paper-toggle-button>
	                	<span id$="index-[[index]]" class="operator-text">[[rule.operator]] </span>
                    </span>
                    <span>
                        <span>
                            on 
                        </span>
                        <span class="uppercase">
                            <span hidden$="[[rule.rtype.length]]">
                                ALL 
                            </span>
                            <span class="uppercase" hidden$="[[!rule.rtype.length]]">
                                [[rule.rtype]]
                            </span>
                        </span>
                    </span>
	                <span>
                        <span hidden$="[[rule.action.length]]">
                        	ALL 
                        </span>
                        <span class="uppercase" hidden$="[[!rule.action.length]]">
                            [[rule.action]] 
		                </span>
	                </span>
	                <span>
		                <span hidden$="[[!rule.rid]]">
		                	where ID = [[rule.rid]] 
		                	<!-- resource info -->
		                	<span class="sub" hidden$="[[!_computeLink(rule.rtype,rule.rid)]]">	- [[_computeLink(rule.rtype,rule.rid)]]</span>
		                	<a class="sub" href$="/[[rule.rtype]]s/[[rule.rid]]" class="blue-link regular" hidden$="[[_computeLink(rule.rtype,rule.rid)]]"> -<iron-icon icon="link"></iron-icon>  [[_computeResourceName(rule.rtype,rule.rid)]]</a>
		                </span>
		                <span hidden$="[[!_ruleHasTags(rule)]]">
		                	where TAGS: 
			                <template is="dom-repeat" items="[[_computeRTags(rule.rtags)]]" as="tag">
			                    <span class="tag">[[tag]]</span>
			                </template>
		                </span>
	                </span>
                    <span class="delete">
                        <iron-icon icon="close" on-tap="_deleteRule"></iron-icon>
                    </span>
	            </div>
	        </template>            
        </div>
        <div class="rules">
            <div class="rule add">
                <span class="index">
                    <iron-icon icon="icons:add-circle" on-tap="_addRule"></iron-icon>
                </span>
            </div>
            <paper-item class="default">
                <paper-toggle-button id="defaultoperator" class="operator" checked$="[[_computeToggle(team.policy.operator)]]" [[_computeDisabled(team)]] on-tap="_changeDefaultOperator"></paper-toggle-button>
                <span class="operator-text">[[team.policy.operator]] </span> 
                every other action ON any other resource
            </paper-item>
        </div>
        <div id="changeRecord" hidden$="[[!formReady]]">
            <h4>Changes: </h4>
            <p>
                Add rule 4.<br/>
                Change ALLOW to DENY in rule 5.<br/>
            </p>
        </div>
        <div class="clearfix bottom-actions xs12">
            <paper-button id="appformsubmit" class="submit-btn pull-left blue" disabled$="[[!formReady]]" raised on-tap="_submitForm">Save policy</paper-button>
            <paper-button class="submit-btn pull-right" on-tap="_resetForm"><iron-icon icon="icons:refresh"></iron-icon>Reset Form</paper-button>
        </div>
    </template>
</dom-module>

<script>
	(function() {
        'use strict';

        Polymer({
            is: 'team-policy',
            properties: {
            	team: Object,
            	model: Object,
                payload: {
                    type: Object,
                    computed: '_computePayload(team)'
                },
                formReady: {
                    type: Boolean,
                    value: false
                },
                hasChanges: {
                    type: Boolean,
                    value: false  
                },
                changes: {
                    type: Array
                }
            },
            _ruleHasTags: function(rule){
            	return Object.keys(rule.rtags).length > 0 ? true : false;
            },
            attached: function(){
                var el = document.getElementById('rules');
                var sortable = Sortable.create(el);                
            },
            _computePayload: function(team){
                return this.team.policy;
            },
            _computeRTags: function(tags){
            	var arrTags = Object.keys(tags); 
                for (var i=0; i < arrTags.length; i++) {
                	var t = arrTags[i];
                	if (tags[t] != null) {
                		arrTags[i] = arrTags[i]+'='+tags[t];
                	}
                }
                return arrTags;
            },
            _computeLink: function(type, id){
            	if (type && id && type != "cloud") {
            		return false;
            	}
            	else if (type == "cloud" && id){
            		return this.model.clouds[id].title;
            	}
                else if (type == "cloud" && !id){
                    return 'all clouds';
                }
            },
            _computeResourceName: function(type, id){
                if (type && id) {                    
                    var mod =  this.model[type+'s'];
                    return mod[id].name;
                }
            },
            _computeToggle: function(operator) {
                return operator == 'ALLOW'? true : false;
            },
            _computeDisabled: function(team) {
                return team.name == 'Owners'? 'disabled' : '';
            },
            _addRule: function(e){
                var s = '<span class="index">'+this.payload.rules.length+'.</span><span><paper-toggle-button id$="index-'+this.payload.rules.length+'" class="operator" on-tap="_changeOperator"></paper-toggle-button><span id$="index-'+this.payload.rules.length+'" class="operator-text">DENY </span></span><span><span>on </span><span class="uppercase"><span>ALL</span></span></span><span><span>ALL </span></span><span></span><span class="delete"><iron-icon icon="close" on-tap="_deleteRule"></iron-icon></span>';
                
                var emptyRule = document.createElement('div')
                    emptyRule.innerHTML = s;
                    emptyRule.classList.add('rule');

                var parent = document.getElementById("rules");
                    Polymer.dom(parent).insertBefore(emptyRule, null);

                var emptyRuleObj = {
                    action:"",
                    operator:"DENY",
                    rid:"",
                    rtags:{},
                    rtype:""
                };
                this.payload.rules.push(emptyRuleObj);
            },
            _deleteRule: function(e){
                var path = e.detail.sourceEvent.path;
                var target = path.find(function(p){
                    return p.classList.contains('rule');
                });
                console.log('CLICk ON delete',target)
                this.$.rules.removeChild(target);
            },
            _changeOperator: function(e){
                var path = e.detail.sourceEvent.path;
                var target = path.find(function(p){
                    return p.tagName == "PAPER-TOGGLE-BUTTON";
                });
                var index = target.getAttribute('id').split('-')[1];
                var newOp = target.attributes.checked ? 'ALLOW' : "DENY";
                var text = document.querySelector('#index-'+index+'.operator-text');
                    text.textContent = newOp;

                // this.updatePayload('rules',index, newRule);
                // this.updatePayload('default');
            },
            _changeDefaultOperator: function(e){
                // this.$.defaultoperator
            }
        });
    })();
</script>