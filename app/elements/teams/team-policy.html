<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/Sortable/Sortable.html">

<dom-module id="team-policy">
	<template>
		<style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="shared-styles">
        .rule span {
        	padding-right: 8px;
        }
        .uppercase {
        	text-transform: uppercase;
        }
        #rules {
        	display: table;
        	padding: 16px;
        }
        .rule {
        	display: table-row;
            cursor: move;
        }
        .rule > span {
        	display: table-cell;
        	padding: 8px;
        }
        .rule > span > span {
        	display: inline-block;
        	vertical-align: middle;
        }
        .sub {
        	font-size: 0.9em;
        	color: rgba(0,0,0,0.54); 
        }
        </style>
        <div id="rules">
	        <template is="dom-repeat" items="[[team.policy.rules]]" as="rule">
	            <div class="rule">
	            	<span>
	            		[[index]]. 
	            	</span>
	            	<span>
	                	[[rule.operator]] 
	                </span>
	                <span>
		                <span hidden$="[[rule.action.length]]">
		                	ALL 
		                </span>
		                <span class="uppercase" hidden$="[[!rule.action.length]]">
		                	[[rule.action]] 
		                </span>
	                </span>
	                <span>
		                <span>
		                	on 
		                </span>
		                <span class="uppercase">
		                	[[rule.rtype]]
		                </span>
	                </span>
	                <span>
		                <span hidden$="[[!rule.rid]]">
		                	where ID = [[rule.rid]] 
		                	<!-- resource info -->
		                	<span class="sub" hidden$="[[!_computeLink(rule.rtype,rule.rid)]]">	- [[_computeLink(rule.rtype,rule.rid)]]</span>
		                	<a class="sub" href$="/[[rule.rtype]]s/[[rule.rid]]" class="blue-link regular" hidden$="[[_computeLink(rule.rtype,rule.rid)]]"> -<iron-icon icon="link"></iron-icon>  [[_computeResourceName(rule.rtype,rule.rid)]]</a>
		                </span>
		                <span hidden$="[[!_ruleHasTags(rule)]]">
		                	where TAGS: 
			                <template is="dom-repeat" items="[[_computeRTags(rule.rtags)]]" as="tag">
			                    <span class="tag">[[tag]]</span>
			                </template>
		                </span>
	                </span>
	            </div>
	        </template>
        </div>
        <paper-item class="no-table">[[team.policy.operator]] every other action ON any other resource</paper-item>
    </template>
</dom-module>

<script>
	(function() {
        'use strict';

        Polymer({
            is: 'team-policy',
            properties: {
            	team: Object,
            	model: Object
            },
            _ruleHasTags: function(rule){
            	return Object.keys(rule.rtags).length > 0 ? true : false;
            },
            attached: function(){
                var el = document.getElementById('rules');
                var sortable = Sortable.create(el);
            },
            _computeRTags: function(tags){
            	var arrTags = Object.keys(tags); 
                for (var i=0; i < arrTags.length; i++) {
                	var t = arrTags[i];
                	if (tags[t] != null) {
                		arrTags[i] = arrTags[i]+'='+tags[t];
                	}
                }
                return arrTags;
            },
            _computeLink: function(type, id){
            	if (type && id && type != "cloud") {
            		return false;
            	}
            	else if (type == "cloud" && id){
            		return this.model.clouds[id].title;
            	}
                else if (type == "cloud" && !id){
                    return 'all clouds';
                }
            },
            _computeResourceName: function(type, id){
                if (type && id) {                    
                    var mod =  this.model[type+'s'];
                    return mod[id].name;
                }
            }
        });
    })();
</script>