<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../section-symbol/section-symbol.html">
<link rel="import" href="../tag-link/tag-link.html">
<link rel="import" href="../theme-color/theme-color.html">
<link rel="import" href="../element-dialog/element-dialog.html">
<dom-module id="page-key">
    <link rel="import" type="css" href="../../styles/main.css">
    <style is="custom-style" include="info-table-style"></style>
    <template>
        <style>
        :host {
            background: #fafafa;
        }

        #content {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
        }

        #container {
            background: #fafafa;
        }

        paper-material {
            padding: 0 20px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .key-is-default {
            padding-left: 10px;
        }

        .key-is-default span {
            display: inline;
            vertical-align: middle;
            opacity: 0.54;
            font-size: 12px;
        }

        .key-is-default iron-icon {
            padding-left: 8px;
        }

        .key-is-default paper-icon-button {
            background-color: #eee;
            border-radius: 32px;
        }

        .info-card {
            position: relative;
        }

        .info-card .copy-key {
            position: absolute;
            right: 16px;
            top: 6px;
            margin: 0;
            background-color: #fff;
            color: #474747;
        }

        .info-card .card-content {
            padding: 16px;
        }

        #keyPublicContainer textarea,
        #keyPrivateContainer textarea {
            height: 120px;
            overflow: auto;
            font-family: monospace;
            width: 100%;
            font-size: 14px;
            line-height: 1.4em;
            padding: 10px 15px;
            box-sizing: border-box;
            background-color: #f8f8f8;
            border-color: #eeedeb;
        }

        #keyPublicContainer textarea {
            height: 120px;
        }

        #keyPrivateContainer {
            text-align: center;
        }

        #keyPrivateContainer textarea {
            height: 440px;
        }

        #keyPrivateContainer #showPrivateKey {
            margin: 20px 0;
        }
        </style>
        <paper-drawer-panel id="drawerPanel" responsive-width="900px" narrow="{{narrowMode}}" drawer-width="272px" disable-edge-swipe>
            <app-sidebar tag="[[tag]]" sections="{{sections}}" current="[[section.id]]" drawer></app-sidebar>
            <paper-header-panel id="container" mode="[[_getMode(narrowMode)]]" view$="[[_actualView(view)]]" main>
                <div class="paper-header">
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <h2 class="flex">{{params.id}}
                        <span class="key-is-default">
                            <template is="dom-if" if="{{key.isDefault}}">
                                <iron-icon icon="communication:vpn-key" class="gold"></iron-icon>
                                <span>Default key</span>
                                <paper-tooltip>{{key.id}} is the default Key</paper-tooltip>
                            </template>
                            <template is="dom-if" if="{{!key.isDefault}}">
                                <paper-icon-button icon="communication:vpn-key" on-tap="makeDefault"></paper-icon-button>
                                <paper-tooltip>Make {{key.id}} the default Key</paper-tooltip>
                            </template>
                        </span>
                    </h2>
                    <app-bar class="horizontal layout center end-justified" query="{{q}}"></app-bar>
                    <paper-icon-button icon="icons:sort"></paper-icon-button>
                    <app-user-menu model="[[model]]"></app-user-menu>
                </div>
                <div id="content">
                    <paper-card class="info-card" heading="Public Key">
                        <paper-button hidden$="[[!publicKey]]" on-tap="copyPublicKey" class="copy-key" raised>Copy</paper-button>
                        <div id="keyPublicContainer" class="card-content">
                            <textarea id="keyPublic">
                                [[publicKey]]
                            </textarea>
                        </div>
                    </paper-card>
                    <paper-card class="info-card" heading="Private Key">
                        <paper-button hidden$="[[!privateKey]]" on-tap="copyPrivateKey" class="copy-key" raised>Copy</paper-button>
                        <div id="keyPrivateContainer" class="card-content">
                            <paper-button hidden$="[[privateKey]]" id="showPrivateKey" raised on-tap="showPrivateKey">Private Key</paper-button>
                            <textarea hidden$="[[!privateKey]]" id="keyPrivate">
                                [[privateKey]]
                            </textarea>
                        </div>
                    </paper-card>
                </div>
                <div class="absolute-bottom-right">
                    <app-fab></app-fab>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
        <element-dialog title="[[dialogOptions.title]]" body="[[dialogOptions.body]]"></element-dialog>
        <template is="dom-if" if="[[key.id]]">
            <iron-ajax id="keyPublicRequest" auto="true" url="/keys/[[key.id]]/public" on-response="handlePublicResponse" on-error="handleError"></iron-ajax>
        </template>
        <iron-ajax id="keyPrivateRequest" url="/keys/[[key.id]]/private" on-response="handlePrivateResponse" on-error="handleError"></iron-ajax>
        <iron-ajax id="keyMakeDefaultRequest" url="/keys/[[key.id]]" method="POST" on-response="handleDefaultResponse" on-error="handleError"></iron-ajax>
        <iron-ajax id="keyEditRequest" url="/keys/[[key.id]]" method="PUT" on-response="handleEditResponse" on-error="handleError"></iron-ajax>
        <iron-ajax id="keyDeleteRequest" url="/keys/[[key.id]]" method="DELETE" on-response="handleDeleteResponse" on-error="handleError"></iron-ajax>
        <paper-toast id="toast"></paper-toast>
    </template>
</dom-module>
<script>
Polymer({
    is: 'page-key',
    enableCustomStyleProperties: true,
    properties: {
        router: Object,
        pageTitle: {
            type: String
        },
        params: {
            type: Object,
            notify: true
        },
        sections: Array,
        section: {
            type: Object,
            notify: true,
            value: {}
        },
        tag: {
            type: String,
            value: ""
        },
        key: {
            type: Object,
            notify: true,
            observer: '_keyChanged'
        },
        publicKey: {
            type: String,
            value: null
        },
        privateKey: {
            type: String,
            value: null
        },
        dialogOptions: {
            type: Object,
            value: {
                title: '',
                body: ''
            }
        }
    },
    _keyChanged: function() {
        this.set('privateKey', null);
    },
    copyPublicKey: function() {
        this.$.keyPublic.select();
        document.execCommand('copy');
        this.$.toast.text = 'The Public Key was copied to clipboard!';
        this.$.toast.open();
    },
    copyPrivateKey: function() {
        this.$.keyPrivate.select();
        document.execCommand('copy');
        this.$.toast.text = 'The Private Key was copied to clipboard!';
        this.$.toast.open();
    },
    addMachine: function(_, params) {

    },
    makeDefault: function(e) {
        this.$.keyMakeDefaultRequest.generateRequest();
    },
    handlePublicResponse: function(data) {
        this.publicKey = data.detail.response;
    },
    showPrivateKey: function() {
        this.$.keyPrivateRequest.generateRequest();
    },
    handlePrivateResponse: function(data) {
        this.privateKey = data.detail.response;
    },
    handleDefaultResponse: function(data) {
        //needs to update the previous default key that it's not the default key anymore
        var k = this.model.keysArray;
        for (var i = 0, len = k.length; i < len; i++) {
            if (k[i].isDefault) {
                k[i].isDefault = false;
                break;
            }
        }
        this.set('key.isDefault', true);
        this.$.toast.text = this.key.id + ' has become your default Key!';
        this.$.toast.open();
    },
    editKey: function() {
        this.$.keyEditRequest.generateRequest();
    },
    handleEditResponse: function() {

    },
    deleteKey: function() {
        var dialog = document.querySelector('#dialog');
        this.set('dialogOptions.title', 'Delete Key');
        this.set('dialogOptions.body', 'Are you sure you want to delete key "' + this.key.id + '"?');
        dialog.open();
        // this.$.keyDeleteRequest.generateRequest();
    },
    handleDeleteResponse: function() {

    },
    handleError: function() {

    },
    _getMode: function(narrow) {
        return narrow ? 'waterfall' : 'scroll';
    },
});
</script>
