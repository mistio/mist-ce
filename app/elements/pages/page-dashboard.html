<link rel="import" href="../../bower_components/polyana-dashboard/polyana-dashboard.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../section-tile/section-tile.html">
<link rel="import" href="../app-incidents/app-incidents.html">
<link rel="import" href="../app-forms/app-forms.html">
<link rel="import" href="../app-fab/app-fab.html">
<link rel="import" href="../logs/log-list.html">
<link rel="import" href="../onb-element/onb-element.html">
<link rel="import" href="../app-header/app-header.html">
<link rel="import" href="../clouds/cloud-info.html">
<link rel="import" href="../clouds/cloud-chip.html">
<dom-module id="page-dashboard">
    <template>
        <style is="custom-style" include="headings"></style>
        <style>
        :host {
            --layout-margin: 0.5em;
        }
        paper-material {
            overflow: auto !important;
        }
        /* layout helper classes */
        #content {
            -webkit-overflow-scrolling: touch;
            padding: 0 36px 80px 36px;
        }

        .flexchild {
            @apply(--layout-flex);
        }

        .flex2child {
            @apply(--layout-flex-2);
        }
        .spacer {
            display: block;
            height: 16px;
        }
        .search.active {
            left: 15px;
        }
        .clouds {
            min-height: 48px;
            transition: all 200ms ease-in;
        }
        .clouds cloud-chip {
            cursor: pointer;
            z-index: 9;
        }        
        .clouds cloud-chip.online .icon {
            background-color: var(--green-color) !important;
        }

        .clouds cloud-chip.offline .icon {
            background-color: var(--red-color) !important;
        }

        paper-button.blue {
            line-height: 30px;
        }

        .sections {
            align-items: flex-start;
            margin-bottom: 1em;
        }
        .incidents {
           margin-bottom: 1em;
           display: block;
           width: 100%;
        }
        a.main-section {
            min-width: 150px;
            flex-basis: 25%;
        }
        .columns {
            @apply(--layout-horizontal);
            flex: 1 100%;
        }
        .left,
        .right,
        .top {
            margin: var(--layout-margin);

        }
        .left, .right {
            @apply(--layout-vertical);
            min-width: 400px;
            align-items: flex-start;
            flex-direction: column;
            flex: 1 50%;
        }
        log-list,
        .graphs {
            margin-bottom: 1em;
            width: 100%;
            overflow: hidden;
        }
        log-list {
            display: block;
        }

        @media (max-width: 489px) {
            a.main-section {
                width: calc(100% - 1em);
            }
        }

        @media (max-width: 639px) {
            a.main-section:first-child {
                min-width: calc(100% - 1em);
            }
        }

        @media (max-width: 1400px) {
            .columns {
                @apply(--layout-vertical);
            }
        }
        @media (min-width: 1900px) {
            paper-toolbar::content #topBar {
                max-width: auto;
            }
            .flex-horizontal-wide {
                @apply(--layout-horizontal);
                flex-wrap: wrap;
            }
            .flexchild-wide-top {
                flex: 1 100%;
            }
        }
        polyana-dashboard {
            position: relative;
        }
        log-list ::content h3,
        polyana-dashboard ::content h3 {
            text-transform: uppercase;
            font-size: 16px;
            font-weight: 400;
            line-height: 36px;
            margin: 0 24px 0 0;
        }
        polyana-dashboard ::content timerange-picker {
            position: absolute;
            right: 0;
            top: 12px;
        }
        polyana-dashboard ::content paper-button {
            margin: 0;
            min-width: 1px;
        }
        polyana-dashboard ::content paper-spinner {
            display: block;
            margin: 0 auto;
        }
        .ovhid {
            overflow: hidden;
        }
        .onb.ovhid {
            height: calc(100vh + 184px);
            margin: -184px auto -104px auto;
            box-sizing: border-box;
            width: 100%;
            max-width: 600px;
            position: relative;
        }
        #onboarding-area {
            position: absolute;
            padding-top: 184px;
            top:0;
            box-sizing: border-box;
            @apply(--layout-vertical);
            align-items: stretch;
            /*justify-content: space-between;*/
            width: 100%;
            max-width: 600px;
            min-height: calc(100vh + 184px);
            height: 100vh;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Chrome/Safari/Opera */
            -khtml-user-select: none;    /* Konqueror */
            -moz-user-select: none;      /* Firefox */
            -ms-user-select: none;       /* Internet Explorer/Edge */
            user-select: none;            
            transition: var(--material-curve-320);     
            transition-delay: 200ms;
        }
        #onboarding-area[higher] {
            height: 115vh;
            min-height: calc(113vh + 184px);
            transform: translate(0, -15vh);
        }
        /*#onboarding-area .onb-graphics {
            transition: var(--material-curve-320);                 
        }
        #onboarding-area[higher] .onb-graphics.top {
            transform: translate(0, -13vh);
        }
        #onboarding-area[higher] .onb-graphics.bottom {
            transform: translate(0, 13vh);
        }*/
        .onb-graphics {
            margin: 0 auto;
            height: auto;
            vertical-align: middle;
        }
        .onb-graphics.top {
            top: 0;
            width: 300px;
            max-width: 100%;
        }
        .onb-graphics.bottom {
            bottom: 0;
            width: 100%;
            max-width: 600px;
            position: absolute;
            margin: 0 auto;
            transition: var(--material-curve-320);
            left: calc(50% - 300px);
        }
        .onboarding-form {
            text-align: center;
        }
        .onboarding-form paper-input {
            text-align: left;
        }
        .onboarding-form-inputs {
            width: 50%;
            min-width: 300px;
            margin: 0 auto;
        }
        .wide {
            padding: 0.7em 1.5em;
        }
        .sub {
            font-size: 0.9em;
            line-height: 1.2em;
            opacity: 0.54;
        }
        .blue-link {
            padding: 0;
            text-transform: none;
        }
        .onb-forms {
            position: relative;
        }
        .onboarding-form {
            position: absolute;
            width: 100%;
            transition: var(--material-curve-320);            
        }        
        .onboarding-form[closed] {
            transform: translate(0, 100vh);
        }
        .onboarding-form {
            transform: translate(0, 0);
        }
        </style>
        <div id="content" class="flex-horizontal-wide" main>
        <template is="dom-if" if="[[showDashboard]]">
                <div class="clouds top flexchild-wide-top">
                    <div class="flex">
                        <template is="dom-repeat" items="[[model.cloudsArray]]">
                            <cloud-chip label="{{item.title}}" class$="link [[isOnline(item)]] [[isOffline(item)]] paper-chip-0" on-tap="_showCloudInfoDialog" id$="[[item.id]]">
                                <div class="icon"></div>
                                <!-- src="[[_computeProviderLogo(item.provider)]]" -->
                                <h1 class="cloud-title">{{item.title}}</h1>
                            </cloud-chip>
                        </template>
                    </div>
                    <div class="ovhid">
                        <cloud-info></cloud-info>
                    </div>
                </div>
                <div class="columns">
                    <div id="leftcolumn" class="left">
                        <template is="dom-if" if="[[model.monitoring]]">
                            <div class="incidents">
                                <app-incidents model="[[model]]" sections="[[sections]]">
                                </app-incidents>
                            </div>
                        </template>
                        <div class="sections layout horizontal wrap">
                            <a href="/machines" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="machines" color="[[sections.machines.color]]" icon="[[sections.machines.icon]]" count="[[model.machinesArray.length]]">
                                </section-tile>
                            </a>
                            <a href="/images" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="images" color="[[sections.images.color]]" icon="[[sections.images.icon]]" count="[[model.imagesArray.length]]"></section-tile>
                            </a>
                            <a href="/keys" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="keys" color="[[sections.keys.color]]" icon="[[sections.keys.icon]]" count="[[model.keysArray.length]]"></section-tile>
                            </a>
                            <a href="/networks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="networks" color="[[sections.networks.color]]" icon="[[sections.networks.icon]]" count="[[model.networksArray.length]]"></section-tile>
                            </a>
                            <a href="/scripts" class="main-section flex" is=" pushstate-anchor">
                                <section-tile name="scripts" color="[[sections.scripts.color]]" icon="[[sections.scripts.icon]]" count="[[model.scriptsArray.length]]"></section-tile>
                            </a>
                            <a href="/templates" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="templates" color="[[sections.templates.color]]" icon="[[sections.templates.icon]]" count="[[model.templatesArray.length]]"></section-tile>
                            </a>
                            <a href="/stacks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="stacks" color="[[sections.stacks.color]]" icon="[[sections.stacks.icon]]" count="[[model.stacksArray.length]]"></section-tile>
                            </a>
                            <a href="/teams" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="teams" color="[[sections.teams.color]]" icon="[[sections.teams.icon]]" count="{{model.teamsArray.length}}"></section-tile>
                            </a>
                        </div>
                        <paper-material class="graphs">
                            <polyana-dashboard dashboard="[[dashboard]]" datasources="[[datasources]]" replace-targets="[[replaceTargets]]"></polyana-dashboard>
                        </paper-material>
                    </div>
                    <paper-material id="rightcolumn" class="left logs">
                        <log-list></log-list>
                    </paper-material>
                </div>
            </div>
        </template>
        <template is="dom-if" if="[[!showDashboard]]">
            <div class="onb ovhid">
                <div id="onboarding-area">
                    <img class="onb-graphics top" src="../../images/onboarding/clouds.svg"/>
                    <div id="org-form" class="onboarding-form" hidden$="[[model.user.orgs.length]]">
                        <h1>Welcome!</h1>
                        <p>One small step to complete your sign up:<br/>
                            Choose an organisation name. *
                        </p>
                        <div id="org-form" class="onboarding-form-inputs">
                            <paper-input id="orginput" value$='[[model.user.email]] Org' placeholder$='[[model.user.email]] Org' tabindex='1'></paper-input>
                            <div class="spacer"></div>
                            <paper-button class="wide blue" on-tap="saveOrg"> Save organisation </paper-button>
                        </div>
                        <div class="spacer"></div>
                        <h4 class="sub">
                            * you can always add more organisations later, <br/>
                            using your profile menu at the top right of your screen
                        </h4>
                    </div>
                    <div class="onb-forms" hidden$="[[!model.user.orgs.length]]">
                        <div id="cloud-or-invite-form" class="onboarding-form">
                            <h1>You are ready to go!</h1>
                            <p>No clouds to manage in <strong>[[model.org.name]]</strong>. Yet.</p>
                            <div class="onboarding-form-inputs">
                                <paper-button class="wide blue" on-tap="goToAddCloud"> Add your clouds </paper-button>
                            </div>
                            <p>
                                or <paper-button on-tap="showInviteForm" class="blue-link" noink>invite people </paper-button> to join you and add clouds.
                            </p>
                        </div>
                        <div id="invite-form" class="onboarding-form" closed>
                            <h1>Invite people in [[model.org.name]]</h1>
                            <p>To add an organisation use the 'Add Organisation' option on your profile menu</p>
                            <div class="onboarding-form-inputs">
                                
                            </div>
                            <paper-button noink on-tap="hideInviteForm" class="blue-link">Cancel</paper-button>
                        </div>
                    </div>
                    <img class="onb-graphics bottom" src="../../images/onboarding/mount.svg"/>
                </div>
            </div>
        </template>
        <div class="absolute-bottom-right">
            <a href="/add-cloud">
                <paper-fab id="addBtn" icon="cloud"></paper-fab>
            </a>
        </div>
    </template>
</dom-module>
<script>

Polymer({
    is: 'page-dashboard',
    enableCustomStyleProperties: true,
    properties: {
        sections: {
            type: Object
        },
        model: {
            type: Object,
            notify: true
        },
        onbstate: {
            type: Number
        },
        q: {
            type: String,
            notify: true
        },
        dashboard: {
            type: Object
        },
        replaceTargets: {
            type: Object,
            computed: '_computeReplaceTargets(model.monitoring)'
        },
        openedCloud: String,
        showDashboard: {
            type: Boolean,
            computed: '_computeshowDashboard(model.cloudsArray.length)',
            notify: true
        }
    },
    listeners: {
        'close-cloud-info': '_closeCloudChips'
    },
    ready: function() {        
    },
    attached: function() {
        // reset page title since this is the default page
        this.fire('page-meta', {
            title: null
        });
        this.datasources = [
          {
          "id": 1,
          "orgId": 1,
          "name": "mistphite",
          "type": "graphite",
          "access": "proxy",
          "uri": "/graphite/",
          "password": "",
          "user": "",
          "database": "",
          "basicAuth": false,
          "basicAuthUser": "",
          "basicAuthPassword": "",
          "withCredentials": false,
          "isDefault": false,
          "jsonData": null
          }
        ];
        this.dashboard = {
          "id": 1,
          "refresh": "10s",
          "rows": [{
            "panels": [{
              "aliasColors": {},
              "datasource": "mistphite",
              "id": 2,
              "span": 12,
              "stack": false,
              "targets": [
                {
                "refId": "A",
                "target": "bucky.*.load.shortterm"
                },
              ],
              "timeFrom": null,
              "timeShift": null,
              "title": "Load on all monitored machines",
              "type": "graph",
              "x-axis": true,
              "y-axis": true
            }],
          }],
          "time": {
            "from": "now-10m",
            "to": "now"
          },
          "timepicker": {
            "now": true,
            "refresh_intervals": [],
            "time_options": [
              "5m",
              "15m",
              "1h",
              "6h",
              "12h",
              "24h",
              "2d",
              "7d",
              "30d"
            ]
          },
          "timezone": "browser"
        };

        var that = this;
        setInterval(function(){ // FIXME: find a better way to fix broken chart width when coming from another page
            if (that.querySelector('dashboard-panel'))
                that.querySelector('dashboard-panel').resize();

        }, 5000);
    },
    isOnline: function(cloud) {
        return cloud.state == 'online' && 'online';
    },
    isOffline: function(cloud) {
        return cloud.state == 'offline' && 'offline';
    },
    _computeshowDashboard: function(cloudslength) {
        // TODO: don't forget to remove comments and last return
        var show;
        if (cloudslength > 0) {
            show =  true;
        }
        else {
            show = false;
            //close sidebar for focus
            window.setTimeout(function(){
                var sidebar = document.querySelector('app-sidebar'),
                    content = document.querySelector('iron-pages');
                sidebar.classList.add('close');
                content.classList.add('center');
            }, 2400);
            // TODO: does not work
            // give focus to paper input
            var input = this.$.orginput;
            if (input) {
                input.focus();
            }
        }
        return show;
    },
    _computeProviderLogo: function(className) {
        return '../assets/providers/provider-' + className.split('_')[0] + '.png';
    },
    _computeReplaceTargets: function(monitoring) {
        var ret = {'bucky.': ''},
            mIds = Object.keys(this.get('model.monitoring.monitored_machines') || {});
        for (var i=0; i<mIds.length; i++) {
            var mref = this.model.monitoring.monitored_machines[mIds[i]],
                m = mref && this.model.clouds[mref.cloud_id].machines[mref.machine_id];
            ret[mIds[i]] = m ? m.name : 'unknown';
        }
        return ret;
    },
    _showCloudInfoDialog: function(e) {
        var cloudId = e.currentTarget.getAttribute('id');
        var dialog = this.querySelector('cloud-info');

        if (this.openedCloud && this.openedCloud == cloudId) {
            dialog.removeAttribute('opened');
            this._closeCloudChips();
            this.set('openedCloud', '');
        }
        else {
            var cloudChips = this.querySelectorAll('cloud-chip'),
                cloud = this.model.cloudsArray.find(function(cloud) {
                    return cloud.id == cloudId;
                });
            [].forEach.call(cloudChips, function(el, index) {
                if (el == e.currentTarget){
                    el.setAttribute('opened', true)
                }
                else {
                    el.removeAttribute('opened');
                }
            });
            this.set('openedCloud', cloudId);
            dialog.cloud = cloud;
            dialog.setAttribute('opened', true);
        }
    },
    _closeCloudChips: function(){
        var cloudChips = this.querySelectorAll('cloud-chip');
        [].forEach.call(cloudChips, function(el, index) {
            el.removeAttribute('opened');
        });
    },
    saveOrg: function(){
        //save org and update model to new organisation context
    },
    goToAddCloud: function(){
        page.show('/add-cloud');
        //show sidebar for navigation
        window.setTimeout(function(){
            var sidebar = document.querySelector('app-sidebar'),
                content = document.querySelector('iron-pages');
            sidebar.classList.remove('close');
            content.classList.remove('center');
        }, 200);
    },
    showInviteForm: function(){
        var addform = document.querySelector("#cloud-or-invite-form"),
            inviteform = document.querySelector("#invite-form"),
            container = document.querySelector("#onboarding-area");
        addform.setAttribute('closed', true);
        inviteform.removeAttribute('closed');
        container.setAttribute('higher', true);
    },
    hideInviteForm: function(){
        var addform = document.querySelector("#cloud-or-invite-form"),
            inviteform = document.querySelector("#invite-form"),
            container = document.querySelector("#onboarding-area");
        addform.removeAttribute('closed');
        inviteform.setAttribute('closed', true);
        container.removeAttribute('higher');
    }
});
</script>
