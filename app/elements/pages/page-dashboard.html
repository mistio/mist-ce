<link rel="import" href="../../bower_components/polyana-dashboard/polyana-dashboard.html">
<link rel="import" href="../section-tile/section-tile.html">
<!--link rel="import" href="../app-incidents/app-incidents.html"-->
<link rel="import" href="../app-forms/app-forms.html">
<link rel="import" href="../app-fab/app-fab.html">
<link rel="import" href="../logs/log-list.html">
<link rel="import" href="../onb-element/onb-element.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../clouds/cloud-info.html">
<dom-module id="page-dashboard">
    <template>
        <style is="custom-style" include="headings"></style>
        <style>
        :host {
            --layout-margin: 0.5em;
        }

        paper-header-panel {
            background: rgb(245, 245, 245);
        }

        paper-header-panel {
            --paper-header-panel-shadow: {
                height: 6px;
                bottom: -6px;
                box-shadow: inset 0 2px 2px 0 rgba(0, 0, 0, 0.14), inset 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }
        }
        /* layout helper classes */

        .flex-horizontal-with-ratios {
            @apply(--layout-horizontal);
            justify-content: stretch;
        }

        .flexchild {
            @apply(--layout-flex);
        }

        .flex2child {
            @apply(--layout-flex-2);
            order: 2;
        }

        .flex3child {
            @apply(--layout-flex-2);
            order: 1;
        }

        .pad {
            padding: 8px;
        }

        .spacer {
            padding: 4px 0;
        }
        /* header */

        paper-toolbar {
            background-color: var(--mist-dark-color);
            color: rgba(255, 255, 255, 0.84);
        }

        paper-toolbar a {
            color: rgba(255, 255, 255, 0.84);
        }

        paper-toolbar::content #topBar.paper-toolbar {
            margin: 0 auto;
        }

        .search.active {
            left: 15px;
        }
        /* clouds */

        .clouds {
            display: flex;
            overflow: hidden;
            padding: 16px 16px 8px 16px;
            background-color: #eee;
            margin: var(--layout-margin);
            margin-bottom: 16px;
            background-color: #dedede;
            box-shadow: 1px 1px 1px 0px rgba(0, 0, 0, 0.1) inset;
            transition: all 100ms ease;
            font-size: 14px;
        }

        .clouds span.cloud-title {
            bottom: -2px;
            position: relative;
        }

        .clouds paper-button.online {
            border-color: green !important;
        }

        .clouds paper-button.offline {
            border-color: #D96557 !important;
        }

        .clouds paper-button:not(#addcoud) {
            background-color: #fff;
            color: inherit;
            border-left: 4px solid #757575;
            margin-bottom: 8px;
            padding: 0.7em 0.57em;
        }

        paper-button:not(#addcoud)::content iron-icon {
            border-radius: 2em;
            background-color: #eee;
            padding: 3px;
        }

        paper-button:not(#addcoud)::content iron-icon[icon='check'] {
            color: green;
        }

        paper-button:not(#addcoud)::content iron-icon[icon='clear'] {
            color: #fff;
            background-color: #D96557;
        }

        paper-button.blue {
            line-height: 30px;
        }

        paper-menu-button {
            padding: 0;
        }

        paper-item {
            font-size: 14px;
        }
        /* sections */

        .sections {
            align-items: stretch;
        }

        a.main-section {
            min-width: 200px;
            margin: var(--layout-margin);
        }
        /* incidents */

        .incidents {
            margin: var(--layout-margin);
            @apply(--layout-horizontal);
            align-items: stretch;
        }
        /* graphs */

        .graphs, .logs {
            margin: var(--layout-margin);
        }
        .graphs {
            margin-bottom: 1em;
        }

        @media (max-width: 489px) {
            a.main-section {
                width: calc(100% - 1em);
            }
        }

        @media (max-width: 639px) {
            a.main-section:first-child {
                min-width: calc(100% - 1em);
            }
        }

        @media (max-width: 639px) {
            .flex-horizontal-with-ratios {
                @apply(--layout-vertical);
            }
            .flex2child {
                order: 1;
            }
            .flex3child {
                order: 2;
            }
        }
        .content {
            padding: 50px 16px;
            margin: 0 auto;
        }
        @media (max-width: 1899px) {
            .content {
                display: block;
                max-width: 1100px;
            }
        }
        @media (min-width: 1900px) {
            paper-toolbar::content #topBar {
                max-width: auto;
            }
            .content {
                max-width: auto !important;
            }
            .flex-horizontal-wide {
                @apply(--layout-horizontal);
                flex-wrap: wrap;
            }
            .flexchild-wide {
                @apply(--layout-flex);
            }
            .flexchild-wide-top {
                flex: 1 100%;
            }
        }

        .onb-area {
            padding: 8px;
        }
        </style>
        <paper-header-panel mode="standard" class="fit">
            <paper-toolbar class="paper-header">
                <app-logo white class="flex"></app-logo>
                <app-bar class="horizontal layout center end-justified" no-search>
                </app-bar>
                <app-user-menu email="[[model.email]]"></app-user-menu>
            </paper-toolbar>
            <div class="content flex-horizontal-wide">
                <div class="clouds flexchild-wide-top">
                    <div class="flex">
                        <template is="dom-repeat" items="[[model.cloudsArray]]">
                            <paper-button raised class$="link [[isOnline(item)]] [[isOffline(item)]]" on-tap="_showCloudInfoDialog" id$="[[item.id]]">
                                <iron-icon src="[[_computeProviderLogo(item.provider)]]"></iron-icon>
                                <span class="cloud-title">{{item.title}}</span>
                            </paper-button>
                        </template>
                    </div>
                </div>
                <div class="container flex-horizontal-with-ratios flexchild-wide">
                    <!-- FIXME: dom-if needs to be here but gives error -->
                    <template is="dom-if" if="[[onbstate]]">
                        <onb-element class="onb-area flex2child top right" onbstate="[[onbstate]]" model="[[model]]"></onb-element>
                    </template>
                    <!--template is="dom-if" if="[[model.monitoring]]">
                        <app-incidents hidden$="[[onbstate]]" id="right" class="flex2child incidents top right" model="[[model]]">
                        </app-incidents>
                    </template-->
                    <div id="left" class="flex3child top left">
                        <div class="sections layout horizontal wrap">
                            <a href="/machines" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="machines" color="[[sections.machines.color]]" icon="[[sections.machines.icon]]" count="[[model.machinesArray.length]]">
                                </section-tile>
                            </a>
                            <a href="/images" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="images" color="[[sections.images.color]]" icon="[[sections.images.icon]]" count="[[model.imagesArray.length]]"></section-tile>
                            </a>
                            <a href="/keys" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="keys" color="[[sections.keys.color]]" icon="[[sections.keys.icon]]" count="[[model.keysArray.length]]"></section-tile>
                            </a>
                            <a href="/networks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="networks" color="[[sections.networks.color]]" icon="[[sections.networks.icon]]" count="[[model.networksArray.length]]"></section-tile>
                            </a>
                            <a href="/scripts" class="main-section flex" is=" pushstate-anchor">
                                <section-tile name="scripts" color="[[sections.scripts.color]]" icon="[[sections.scripts.icon]]" count="[[model.scriptsArray.length]]"></section-tile>
                            </a>
                            <a href="/templates" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="templates" color="[[sections.templates.color]]" icon="[[sections.templates.icon]]" count="[[model.templatesArray.length]]"></section-tile>
                            </a>
                            <a href="/stacks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="stacks" color="[[sections.stacks.color]]" icon="[[sections.stacks.icon]]" count="[[model.stacksArray.length]]"></section-tile>
                            </a>
                            <a href="/teams" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="teams" color="[[sections.teams.color]]" icon="[[sections.teams.icon]]" count="{{model.teamsArray.length}}"></section-tile>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="bottom full flexchild-wide">
                    <div class="graphs">
                        <polyana-dashboard dashboard="[[dashboard]]" datasources="[[datasources]]" replace-targets="[[replaceTargets]]"></polyana-dashboard>
                    </div>
                    <div class="logs">
                        <log-list></log-list>
                    </div>
                </div>
                <div class="absolute-bottom-right">
                    <a href="/add-cloud">
                        <paper-fab id="addBtn" icon="add"></paper-fab>
                    </a>
                </div>
            </div>
        </paper-header-panel>
        <cloud-info></cloud-info>
    </template>
</dom-module>
<script>

Polymer({
    is: 'page-dashboard',
    enableCustomStyleProperties: true,
    properties: {
        sections: {
            type: Array
        },
        model: {
            type: Object,
            notify: true
        },
        onbstate: {
            type: Number
        },
        q: {
            type: String,
            notify: true
        },
        dashboard: {
            type: Object
        },
        replaceTargets: {
            type: Object,
            computed: '_computeReplaceTargets(model.monitoring)'
        }
    },
    ready: function() {},
    attached: function() {
        // reset page title since this is the default page
        this.fire('page-meta', {
            title: null
        });
        this.datasources = [
          {
          "id": 1,
          "orgId": 1,
          "name": "mistphite",
          "type": "graphite",
          "access": "proxy",
          "uri": "/graphite/",
          "password": "",
          "user": "",
          "database": "",
          "basicAuth": false,
          "basicAuthUser": "",
          "basicAuthPassword": "",
          "withCredentials": false,
          "isDefault": false,
          "jsonData": null
          }
        ];
        this.dashboard = {
          "id": 1,
          "refresh": "10s",
          "rows": [{
            "panels": [{
              "aliasColors": {},
              "datasource": "mistphite",
              "id": 2,
              "span": 12,
              "stack": false,
              "targets": [
                {
                "refId": "A",
                "target": "bucky.*.load.shortterm"
                },
              ],
              "timeFrom": null,
              "timeShift": null,
              "title": "Load on all monitored machines",
              "type": "graph",
              "x-axis": true,
              "y-axis": true
            }],
          }],
          "time": {
            "from": "now-10m",
            "to": "now"
          },
          "timepicker": {
            "now": true,
            "refresh_intervals": [],
            "time_options": [
              "5m",
              "15m",
              "1h",
              "6h",
              "12h",
              "24h",
              "2d",
              "7d",
              "30d"
            ]
          },
          "timezone": "browser"
        };

        var that = this;
        setInterval(function(){ // FIXME: find a better way to fix broken chart width when coming from another page
            if (that.querySelector('dashboard-panel'))
                that.querySelector('dashboard-panel').resize();

        }, 5000);
    },
    isOnline: function(cloud) {
        return cloud.state == 'online' && 'online';
    },
    isOffline: function(cloud) {
        return cloud.state == 'offline' && 'offline';
    },
    _computeProviderLogo: function(className) {
        return '../assets/providers/provider-' + className.split('_')[0] + '.png';
    },
    _computeReplaceTargets: function(monitoring) {
        var ret = {'bucky.': ''},
            mIds = Object.keys(this.get('model.monitoring.monitored_machines') || {});
        for (var i=0; i<mIds.length; i++) {
            var mref = this.model.monitoring.monitored_machines[mIds[i]],
                m = mref && this.model.clouds[mref.cloud_id].machines[mref.machine_id];
            ret[mIds[i]] = m ? m.name : 'unknown';
        }
        return ret;
    },
    _showCloudInfoDialog: function(e) {
        var cloudId = e.currentTarget.getAttribute('id'),
        dialog = this.querySelector('cloud-info'),
        cloud = this.model.cloudsArray.find(function(cloud) {
            return cloud.id == cloudId;
        });
        dialog.cloud = cloud;
        dialog._openDialog();
    }
});
</script>
