<link rel="import" href="../../bower_components/polyana-dashboard/polyana-dashboard.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/pushstate-anchor/pushstate-anchor.html">

<link rel="import" href="../section-tile/section-tile.html">
<link rel="import" href="../app-incidents/app-incidents.html">
<link rel="import" href="../app-costs/app-costs.html">
<link rel="import" href="../app-forms/app-forms.html">
<link rel="import" href="../app-fab/app-fab.html">
<link rel="import" href="../logs/log-list.html">
<link rel="import" href="../onb-element/onb-element.html">
<link rel="import" href="../app-header/app-header.html">
<link rel="import" href="../clouds/cloud-info.html">
<link rel="import" href="../clouds/cloud-chip.html">
<dom-module id="page-dashboard">
    <template>
        <style is="custom-style" include="headings"></style>
        <style>
        :host {
            /*--layout-margin: 0.5em;*/
            --layout-margin: 16px;
        }
        paper-material {
            overflow: auto !important;
        }
        /* layout helper classes */
        #content {
            -webkit-overflow-scrolling: touch;
            padding: 0 36px 80px 36px;
        }

        .flexchild {
            @apply(--layout-flex);
        }

        .flex2child {
            @apply(--layout-flex-2);
        }
        .spacer {
            display: block;
            height: 16px;
        }
        .search.active {
            left: 15px;
        }
        .clouds {
            min-height: 48px;
            transition: all 200ms ease-in;
        }
        .clouds cloud-chip {
            cursor: pointer;
            z-index: 9;
        }
        .clouds cloud-chip.online .icon {
            background-color: var(--green-color) !important;
        }

        .clouds cloud-chip.offline .icon {
            background-color: var(--red-color) !important;
        }

        paper-button.blue {
            line-height: 30px;
            font-weight: 500;
        }

        .sections {
            align-items: flex-start;
            /*margin-bottom: 1em;*/
            margin-bottom: 32px;
        }
        .costs,
        .incidents {
           /*margin-bottom: 1em;*/
            margin-bottom: 32px;
            display: block;
            width: 100%;
        }
        a.main-section {
            min-width: 150px;
            flex-basis: 25%;
        }
        .columns {
            @apply(--layout-horizontal);
            flex: 1 100%;
        }
        .left,
        .right,
        .top {
            margin: var(--layout-margin);

        }
        .left, .right {
            @apply(--layout-vertical);
            min-width: 400px;
            align-items: flex-start;
            flex-direction: column;
            flex: 1 50%;
        }
        .logs {
            width: 100%;
            flex: 1 100%;
        }
        log-list,
        .graphs {
            margin-bottom: 1em;
            width: 100%;
            overflow: hidden;
        }
        log-list {
            display: block;
        }

        @media (max-width: 489px) {
            a.main-section {
                width: calc(100% - 1em);
            }
        }

        @media (max-width: 639px) {
            a.main-section:first-child {
                min-width: calc(100% - 1em);
            }
        }

        @media (max-width: 1400px) {
            .columns {
                @apply(--layout-vertical);
            }
        }
        @media (min-width: 1900px) {
            paper-toolbar::content #topBar {
                max-width: auto;
            }
            .flex-horizontal-wide {
                @apply(--layout-horizontal);
                flex-wrap: wrap;
            }
            .flexchild-wide-top {
                flex: 1 100%;
            }
        }
        polyana-dashboard {
            position: relative;
        }
        log-list ::content h3,
        polyana-dashboard ::content h3 {
            text-transform: uppercase;
            font-size: 16px;
            font-weight: 400;
            line-height: 36px;
            margin: 0 24px 0 0;
        }
        polyana-dashboard ::content timerange-picker {
            position: absolute;
            right: 0;
            top: 12px;
        }
        polyana-dashboard ::content paper-button {
            margin: 0;
            min-width: 1px;
        }
        polyana-dashboard ::content paper-spinner {
            display: block;
            margin: 0 auto;
        }
        #content.onb-true {
            background: url('../../images/onboarding/mount.svg') center bottom transparent no-repeat;
            padding-bottom: 0;
            min-height: 100vh;
            margin-right: -24px;
            margin-left: -24px;
            padding-left: 24px;
            padding-right: 24px; 
        }
        .ovhid {
            overflow: hidden;
        }
        .onb.ovhid {
            height: calc(100vh + 184px);
            box-sizing: border-box;
            position: relative;
        }
        #org-form {
            text-align: center;
            padding-bottom: 200px;
        }
        #onboarding-area {
            margin: 0 auto;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
            @apply(--layout-vertical);
            width: 100%;
            max-width: 600px;
            height: auto;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Chrome/Safari/Opera */
            -khtml-user-select: none;    /* Konqueror */
            -moz-user-select: none;      /* Firefox */
            -ms-user-select: none;       /* Internet Explorer/Edge */
            user-select: none;            
            transition: var(--material-curve-320);     
            transition-delay: 200ms;
        }
        #onboarding-area[higher] {
            transform: translate(0, -150px);
        }
        .onb-graphics {
            margin: 0 auto;
            height: auto;
            vertical-align: middle;
            top: 0;
            width: 200px;
            max-width: 100%;
        }
        .onboarding-form {
            text-align: center;
            z-index: 1;
            position: relative;
        }
        #org-form paper-input,
        .onboarding-form paper-input {
            text-align: left;
        }
        .onboarding-form-inputs {
            width: 50%;
            min-width: 300px;
            margin: 0 auto;
        }
        .wide {
            padding: 0.7em 1.5em;
        }
        .sub {
            font-size: 0.9em;
            line-height: 1.2em;
            opacity: 0.54;
        }
        .blue-link {
            padding: 0;
            text-transform: none;
            font-weight: 400; 
        }
        .onb-forms {
            position: relative;
        }
        .onboarding-form {
            position: absolute;
            width: 100%;
            transition: var(--material-curve-320);            
        }        
        .onboarding-form[closed] {
            transform: translate(0, 200vh);
        }
        .onboarding-form {
            transform: translate(0, 0);
        }
        hr.shorten {
            width: 35%;
            margin: 0 auto;
            opacity: 0.32;
            margin-bottom: 2em;
        }
        .grid-row {
            text-align: left;
        }
        .field-helptext {
            font-size: 14px;             
            align-self: center;
            color: rgba(0,0,0,0.54);
        }
        .invite-form-inputs {
            margin-bottom: 2em;   
        }
        paper-dropdown-menu {
            width: 100%;
        }
        </style>
        <div id="content" class$="flex-horizontal-wide onb-[[!showDashboard]]" main>
        <template is="dom-if" if="[[showDashboard]]">
                <div class="clouds top flexchild-wide-top">
                    <div class="flex">
                        <template is="dom-repeat" items="[[model.cloudsArray]]">
                            <cloud-chip label="{{item.title}}" class$="link [[isOnline(item)]] [[isOffline(item)]] paper-chip-0" on-tap="_showCloudInfoDialog" id$="[[item.id]]">
                                <div class="icon"></div>
                                <!-- src="[[_computeProviderLogo(item.provider)]]" -->
                                <h1 class="cloud-title">{{item.title}}</h1>
                            </cloud-chip>
                        </template>
                    </div>
                    <div class="ovhid">
                        <cloud-info></cloud-info>
                    </div>
                </div>
                <div class="columns">
                    <div id="leftcolumn" class="left">
                        <template is="dom-if" if="[[model.monitoring]]">
                            <div class="incidents">
                                <app-incidents model="[[model]]" sections="[[sections]]">
                                </app-incidents>
                            </div>
                        </template>
                        <div class="sections layout horizontal wrap">
                            <a href="/machines" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="machines" color="[[sections.machines.color]]" icon="[[sections.machines.icon]]" count="[[model.machinesArray.length]]">
                                </section-tile>
                            </a>
                            <a href="/images" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="images" color="[[sections.images.color]]" icon="[[sections.images.icon]]" count="[[model.imagesArray.length]]"></section-tile>
                            </a>
                            <a href="/keys" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="keys" color="[[sections.keys.color]]" icon="[[sections.keys.icon]]" count="[[model.keysArray.length]]"></section-tile>
                            </a>
                            <a href="/networks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="networks" color="[[sections.networks.color]]" icon="[[sections.networks.icon]]" count="[[model.networksArray.length]]"></section-tile>
                            </a>
                            <a href="/scripts" class="main-section flex" is=" pushstate-anchor">
                                <section-tile name="scripts" color="[[sections.scripts.color]]" icon="[[sections.scripts.icon]]" count="[[model.scriptsArray.length]]"></section-tile>
                            </a>
                            <a href="/templates" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="templates" color="[[sections.templates.color]]" icon="[[sections.templates.icon]]" count="[[model.templatesArray.length]]"></section-tile>
                            </a>
                            <a href="/stacks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="stacks" color="[[sections.stacks.color]]" icon="[[sections.stacks.icon]]" count="[[model.stacksArray.length]]"></section-tile>
                            </a>
                            <a href="/teams" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="teams" color="[[sections.teams.color]]" icon="[[sections.teams.icon]]" count="{{model.teamsArray.length}}"></section-tile>
                            </a>
                        </div>
                        <paper-material class="graphs">
                            <polyana-dashboard dashboard="[[dashboard]]" datasources="[[datasources]]" replace-targets="[[replaceTargets]]"></polyana-dashboard>
                        </paper-material>
                    </div>
                    <paper-material id="rightcolumn" class="left logs">
                        <log-list></log-list>
                    </paper-material>
                </div>
                <div class="left">
                    <div class="costs">
                        <app-costs model="[[model]]" sections="[[sections]]">
                        </app-costs>
                    </div>
                    <paper-material id="rightcolumn" class="logs">
                        <log-list></log-list>
                    </paper-material>
                </div>
            </div>
        </template>
        <template is="dom-if" if="[[!showDashboard]]">
            <div id="onboarding-area">
                <img class="onb-graphics top" src="../../images/onboarding/clouds.svg"/>
                <div id="org-form" hidden$="[[hasOrg]]">
                    <h1>Welcome!</h1>
                    <p>One small step to complete your sign up:<br/>
                        Choose an organisation name. *
                    </p>
                    <div class="onboarding-form-inputs">
                        <paper-input id="orginput" value$='[[model.user.email]] Org' placeholder$='[[model.user.email]] Org' tabindex='1'></paper-input>
                        <div class="spacer"></div>
                        <paper-button class="wide blue" on-tap="saveOrg"> Save organisation </paper-button>
                    </div>
                    <div class="spacer"></div>
                    <h4 class="sub">
                        * you can always add more organisations later, <br/>
                        using your profile menu at the top right of your screen
                    </h4>
                </div>
                <div class="onb-forms" hidden$="[[!hasOrg]]">
                    <div id="cloud-or-invite-form" class="onboarding-form">
                        <h1>You are ready to go!</h1>
                        <p>No clouds to manage in <strong>[[model.org.name]]</strong>. Yet.</p>
                        <div class="onboarding-form-inputs">
                            <paper-button class="wide blue" on-tap="goToAddCloud"> Add your clouds </paper-button>
                        </div>
                        <p>
                            or <paper-button on-tap="showInviteForm" class="blue-link" noink>invite people </paper-button> to join you and add clouds.
                        </p>
                    </div>
                    <div id="invite-form" class="onboarding-form" closed>
                        <h1>Invite people in [[model.org.name]]</h1>
                        <p>To change or add an organisation use options on your profile menu</p>
                        <hr class="shorten"/>
                        <div class="invite-form-inputs">
                            <div class="grid-row">
                                <div class="xs12 m6 l6">
                                    <paper-dropdown-menu label="Team">
                                        <paper-listbox class="dropdown-content" selected="1">
                                            <template is="dom-repeat" items="[[model.teamsArray]]">
                                                <paper-item>[[item.name]]</paper-item>
                                            </template>
                                        </paper-listbox>
                                    </paper-dropdown-menu>
                                </div>
                                <div class="field-helptext xs12 m6 l6">
                                    Heads up! <br/>Owner's Team members have FULL access to all Organisation's resources. To create another team with a different policy use the <paper-button on-tap="goToAddTeam" class="blue-link" noink>add team form</paper-button>
                                </div>
                                <div class="xs12 m6 l6">
                                    <paper-textarea label="Members Emails" rows="5"'></paper-textarea>
                                </div>
                                <div class="field-helptext xs12 m6 l6">
                                    Invited members will receive an invation email to confirm their membership. They will have permissions according to their teams's policy. Make sure you have allowed some basic access such as view clouds.</paper-button>
                                </div>
                            </div>
                        </div>
                        <paper-button on-tap="invitePeople" class="blue wide" noink>Invite People</paper-button>
                        <div class="spacer"></div>
                        <paper-button noink on-tap="hideInviteForm" class="blue-link">Cancel</paper-button>
                    </div>
                </div>
            </div>
        </template>
        <div class="absolute-bottom-right">
            <a href="/add-cloud">
                <paper-fab id="addBtn" icon="cloud"></paper-fab>
            </a>
        </div>
        <iron-ajax id="saveOrgRequest" method="PUT" url="/api/v1/org/[[model.org.id]]"></iron-ajax>
    </template>
</dom-module>
<script>

Polymer({
    is: 'page-dashboard',
    enableCustomStyleProperties: true,
    properties: {
        sections: {
            type: Object
        },
        model: {
            type: Object,
            notify: true
        },
        onbstate: {
            type: Number
        },
        q: {
            type: String,
            notify: true
        },
        dashboard: {
            type: Object
        },
        replaceTargets: {
            type: Object,
            computed: '_computeReplaceTargets(model.monitoring)'
        },
        openedCloud: String,
        showDashboard: {
            type: Boolean,
            value: true,
            computed: '_computeshowDashboard(model.cloudsArray.length)',
            notify: true
        },
        hasOrg: {
            type: Boolean,
            computed: '_computeHasOrg(model.org.name.*)',
            notify: true
        }
    },
    listeners: {
        'close-cloud-info': '_closeCloudChips'
    },
    ready: function() {
    },
    attached: function() {
        // reset page title since this is the default page
        this.fire('page-meta', {
            title: null
        });
        this.datasources = [
          {
          "id": 1,
          "orgId": 1,
          "name": "mistphite",
          "type": "graphite",
          "access": "proxy",
          "uri": "/graphite/",
          "password": "",
          "user": "",
          "database": "",
          "basicAuth": false,
          "basicAuthUser": "",
          "basicAuthPassword": "",
          "withCredentials": false,
          "isDefault": false,
          "jsonData": null
          }
        ];
        this.dashboard = {
          "id": 1,
          "refresh": "10s",
          "rows": [{
            "panels": [{
              "aliasColors": {},
              "datasource": "mistphite",
              "id": 2,
              "span": 12,
              "stack": false,
              "targets": [
                {
                "refId": "A",
                "target": "bucky.*.load.shortterm"
                },
              ],
              "timeFrom": null,
              "timeShift": null,
              "title": "Load on all monitored machines",
              "type": "graph",
              "x-axis": true,
              "y-axis": true
            }],
          }],
          "time": {
            "from": "now-10m",
            "to": "now"
          },
          "timepicker": {
            "now": true,
            "refresh_intervals": [],
            "time_options": [
              "5m",
              "15m",
              "1h",
              "6h",
              "12h",
              "24h",
              "2d",
              "7d",
              "30d"
            ]
          },
          "timezone": "browser"
        };

        var that = this;
        setInterval(function(){ // FIXME: find a better way to fix broken chart width when coming from another page
            if (that.querySelector('dashboard-panel'))
                that.querySelector('dashboard-panel').resize();

        }, 5000);
    },
    isOnline: function(cloud) {
        return cloud.state == 'online' && 'online';
    },
    isOffline: function(cloud) {
        return cloud.state == 'offline' && 'offline';
    },
    _computeHasOrg: function (name) {
        console.log(name, name.base);

        if (name.value == '') {
            return false;
        }
        else {
            return true;
        }
    },
    _computeshowDashboard: function(cloudslength) {
        var show;
        if (cloudslength > 0) {
            show =  true;
        }
        else {
            show = false;
            // TODO: does not work. hides no matter
            // this.hideSidebar();
        }
        return show;
    },
    hideSidebar: function(){
        // if we are on boarding, close sidebar for focus
        window.setTimeout(function(){
            var sidebar = document.querySelector('app-sidebar'),
                content = document.querySelector('iron-pages');
            sidebar.classList.add('close');
            content.classList.add('center');
        }, 2400);
    },
    _computeProviderLogo: function(className) {
        return '../assets/providers/provider-' + className.split('_')[0] + '.png';
    },
    _computeReplaceTargets: function(monitoring) {
        var ret = {'bucky.': ''},
            mIds = Object.keys(this.get('model.monitoring.monitored_machines') || {});
        for (var i=0; i<mIds.length; i++) {
            var mref = this.model.monitoring.monitored_machines[mIds[i]],
                m = mref && this.model.clouds[mref.cloud_id].machines[mref.machine_id];
            ret[mIds[i]] = m ? m.name : 'unknown';
        }
        return ret;
    },
    _showCloudInfoDialog: function(e) {
        var cloudId = e.currentTarget.getAttribute('id');
        var dialog = this.querySelector('cloud-info');

        if (this.openedCloud && this.openedCloud == cloudId) {
            dialog.removeAttribute('opened');
            this._closeCloudChips();
            this.set('openedCloud', '');
        }
        else {
            var cloudChips = this.querySelectorAll('cloud-chip'),
                cloud = this.model.cloudsArray.find(function(cloud) {
                    return cloud.id == cloudId;
                });
            [].forEach.call(cloudChips, function(el, index) {
                if (el == e.currentTarget){
                    el.setAttribute('opened', true)
                }
                else {
                    el.removeAttribute('opened');
                }
            });
            this.set('openedCloud', cloudId);
            dialog.cloud = cloud;
            dialog.setAttribute('opened', true);
        }
    },
    _closeCloudChips: function(){
        var cloudChips = this.querySelectorAll('cloud-chip');
        [].forEach.call(cloudChips, function(el, index) {
            el.removeAttribute('opened');
        });
    },
    saveOrg: function(){
        var new_name = this.querySelector("#orginput").value;
        this.$.saveOrgRequest.headers["Content-Type"] = 'application/json';
        this.$.saveOrgRequest.headers["Csrf-Token"] = CSRF_TOKEN;
        this.$.saveOrgRequest.body = { 'new_name': new_name };
        // this.$.saveOrgRequest.params['new_name'] =  new_name;

        // console.log('SAVE ORG', new_name, this.$.saveOrgRequest)
        this.$.saveOrgRequest.generateRequest();
    },
    goToAddTeam: function(){
        page.show('/add-team');
        this.showSidebar();
    },
    goToAddCloud: function(){
        page.show('/add-cloud');    
        this.showSidebar();    
    },
    showSidebar: function(){
        //show sidebar for navigation
        window.setTimeout(function(){
            var sidebar = document.querySelector('app-sidebar'),
                content = document.querySelector('iron-pages');
            sidebar.classList.remove('close');
            content.classList.remove('center');
        }, 200);
    },
    showInviteForm: function(){
        var addform = document.querySelector("#cloud-or-invite-form"),
            inviteform = document.querySelector("#invite-form"),
            container = document.querySelector("#onboarding-area");
        addform.setAttribute('closed', true);
        inviteform.removeAttribute('closed');
        container.setAttribute('higher', true);
    },
    hideInviteForm: function(){
        var addform = document.querySelector("#cloud-or-invite-form"),
            inviteform = document.querySelector("#invite-form"),
            container = document.querySelector("#onboarding-area");
        addform.removeAttribute('closed');
        inviteform.setAttribute('closed', true);
        container.removeAttribute('higher');
    },
    invitePeople: function(){

    }
});
</script>
