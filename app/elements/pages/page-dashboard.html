<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polyana-dashboard/polyana-dashboard.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/pushstate-anchor/pushstate-anchor.html">

<link rel="import" href="../section-tile/section-tile.html">
<link rel="import" href="../app-incidents/app-incidents.html">
<link rel="import" href="../app-costs/app-costs.html">
<link rel="import" href="../app-costs/app-costs-per-tag.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<!-- needed for the forms' inputs -->
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-behavior.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-addon-behavior.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">

<link rel="import" href="../logs/log-list.html">
<link rel="import" href="../onb-element/onb-element.html">
<link rel="import" href="../app-header/app-header.html">
<link rel="import" href="../clouds/cloud-info.html">
<link rel="import" href="../clouds/cloud-chip.html">

<dom-module id="page-dashboard">
    <template>
        <style is="custom-style" include="headings"></style>
        <style>
        :host {
            /*--layout-margin: 0.5em;*/
            --layout-margin: 16px;
        }
        paper-material {
            overflow: auto !important;
        }
        /* layout helper classes */
        #content {
            -webkit-overflow-scrolling: touch;
            padding: 0 36px 80px 36px;
            padding: 0 0 80px;

            position: relative;
        }

        .flexchild {
            @apply(--layout-flex);
        }

        .flex2child {
            @apply(--layout-flex-2);
        }
        .search.active {
            left: 15px;
        }
        .clouds {
            min-height: 48px;
            transition: all 200ms ease-in;
        }
        .clouds cloud-chip {
            cursor: pointer;
            z-index: 9;
        }
        .clouds cloud-chip.online .icon {
            background-color: var(--green-color) !important;
        }

        .clouds cloud-chip.offline .icon {
            background-color: var(--red-color) !important;
        }

        paper-button.blue {
            line-height: 30px;
            font-weight: 500;
        }

        .sections {
            align-items: flex-start;
            /*margin-bottom: 1em;*/
            margin-bottom: 32px;
            width: 100%;
        }
        .costs,
        .incidents {
           /*margin-bottom: 1em;*/
            display: block;
            width: 100%;
        }
        .incidents {
            padding-bottom: 32px;
        }
        .costs {
            margin-bottom: 32px;
        }
        a.main-section {
            min-width: 120px;
            flex-basis: 25%;
        }
        .columns {
            @apply(--layout-horizontal);
            flex: 1 100%;
        }
        .left,
        .right,
        .top {
            margin: var(--layout-margin);

        }
        .left, .right {
            @apply(--layout-vertical);
            min-width: 400px;
            align-items: flex-start;
            flex-direction: column;
            flex: 1 50%;
        }
        .logs {
            width: 100%;
            flex: 1 100%;
        }
        log-list,
        .graphs {
            margin-bottom: 1em;
            width: 100%;
            overflow: hidden;
        }
        log-list {
            display: block;
        }

        @media (max-width: 489px) {
            a.main-section {
                width: calc(100% - 1em);
            }
        }

        @media (max-width: 639px) {
            a.main-section:first-child {
                min-width: calc(100% - 1em);
            }
        }

        @media (max-width: 1400px) {
            .columns {
                @apply(--layout-vertical);
            }
        }
        @media (min-width: 1900px) {
            paper-toolbar::content #topBar {
                max-width: auto;
            }
            .flex-horizontal-wide {
                @apply(--layout-horizontal);
                flex-wrap: wrap;
            }
            .onb-true.flex-horizontal-wide {
                @apply(--layout-none);
                display: block;
            }
            .flexchild-wide-top {
                flex: 1 100%;
            }
        }
        polyana-dashboard {
            position: relative;
        }
        log-list ::content h3,
        polyana-dashboard ::content h3 {
            text-transform: uppercase;
            font-size: 16px;
            font-weight: 400;
            line-height: 36px;
            margin: 0 24px 0 0;
        }
        polyana-dashboard ::content timerange-picker {
            position: absolute;
            right: 0;
            top: 12px;
        }
        timerange-picker {
            display: flex;
        }
        polyana-dashboard ::content paper-button {
            margin: 0;
            min-width: 1px;
        }
        polyana-dashboard ::content paper-spinner {
            display: block;
            margin: 0 auto;
        }
        #content.onb-true {
            background: url('../../images/onboarding/mount.svg') center bottom transparent no-repeat;
            padding-bottom: 0;
            min-height: 100vh;
            margin-right: -24px;
            margin-left: -24px;
            padding-left: 24px;
            padding-right: 24px;
        }
        .ovhid {
            overflow: hidden;
        }
        .onb.ovhid {
            height: calc(100vh + 184px);
            box-sizing: border-box;
            position: relative;
        }
        .wide {
            padding: 0.7em 1.5em;
        }
        .is-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
            z-index: 98;
            background-color: #eee;
        }
        paper-spinner {
            width: 80px;
            height: 80px;
            margin: 10% auto;
            display: block;
        }
        .notice {
            background-color: #ffff8d;
            padding: 2px 16px;
            margin: 0 16px;
            z-index: 98;
        }
        .onb-true .notice {
            flex: 0 0;
            width: auto;
            max-width: 100%;
        }
        </style>
        <div id="content" class$="flex-horizontal-wide onb-[[!showDashboard]]" main>
        <div class="notice">
            <p><strong>Note:</strong> Hello! Here we are providing an early preview of the new Mist.io UI. Keep in mind, it is under heavy development so expect rough edges and some missing functionality. We would appreciate your feedback! Send suggestions to <a href="mailto:support@mist.io">support@mist.io</a>.
            <a href="javascript:void(0)" on-tap="_toggleUI" class="flex">Return to old UI</a>
            </p>
        </div>
        <template is="dom-if" if="[[showDashboard]]">
                <div class="clouds top flexchild-wide-top">                    
                    <div id="cloudslist" class="flex">
                        <template is="dom-repeat" items="[[model.cloudsArray]]">
                            <cloud-chip label="{{item.title}}" class$="link [[isOnline(item)]] [[isOffline(item)]]" index$=[[index]] on-tap="_showCloudInfoDialog" id$="[[item.id]]">
                                <div class="icon"></div>
                                <!-- src="[[_computeProviderLogo(item.provider)]]" -->
                                <h1 class="cloud-title">[[item.title]]</h1>
                            </cloud-chip>
                        </template>
                    </div>
                    <div class="ovhid">
                        <cloud-info></cloud-info>
                    </div>
                </div>
                <div class="columns">
                    <div id="leftcolumn" class="left">
                        <template is="dom-if" if="[[hasIncidents]]">
                            <div class="incidents">
                                <app-incidents model="[[model]]" sections="[[sections]]">
                                </app-incidents>
                            </div>
                        </template>
                        <div class="sections layout horizontal wrap">
                            <a href="/machines" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="machines" color="[[sections.machines.color]]" icon="[[sections.machines.icon]]" count="[[model.machinesArray.length]]">
                                </section-tile>
                            </a>
                            <a href="/images" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="images" color="[[sections.images.color]]" icon="[[sections.images.icon]]" count="[[model.imagesArray.length]]"></section-tile>
                            </a>
                            <a href="/keys" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="keys" color="[[sections.keys.color]]" icon="[[sections.keys.icon]]" count="[[model.keysArray.length]]"></section-tile>
                            </a>
                            <a href="/networks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="networks" color="[[sections.networks.color]]" icon="[[sections.networks.icon]]" count="[[model.networksArray.length]]"></section-tile>
                            </a>
                            <a href="/scripts" class="main-section flex" is=" pushstate-anchor">
                                <section-tile name="scripts" color="[[sections.scripts.color]]" icon="[[sections.scripts.icon]]" count="[[model.scriptsArray.length]]"></section-tile>
                            </a>
                            <a href="/templates" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="templates" color="[[sections.templates.color]]" icon="[[sections.templates.icon]]" count="[[model.templatesArray.length]]"></section-tile>
                            </a>
                            <a href="/stacks" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="stacks" color="[[sections.stacks.color]]" icon="[[sections.stacks.icon]]" count="[[model.stacksArray.length]]"></section-tile>
                            </a>
                            <a href="/teams" class="main-section flex" is="pushstate-anchor">
                                <section-tile name="teams" color="[[sections.teams.color]]" icon="[[sections.teams.icon]]" count="{{model.teamsArray.length}}"></section-tile>
                            </a>
                        </div>
                        <paper-material class="graphs" hidden$="[[!onboarding.hasMonitoring]]">
                            <polyana-dashboard dashboard="[[dashboard]]" datasources="[[datasources]]" replace-targets="[[replaceTargets]]"></polyana-dashboard>
                        </paper-material>
                    </div>
                    <div class="left">
                        <div class="costs">
                            <app-costs model="[[model]]" sections="[[sections]]">
                            </app-costs>
                            <app-costs-per-tag model="[[model]]" sections="[[sections]]">
                            </app-costs-per-tag>
                        </div>
                        <paper-material id="rightcolumn" class="logs">
                            <log-list></log-list>
                        </paper-material>
                    </div>
                </div>
            </div>
        </template>
        <template is="dom-if" if="[[!showDashboard]]">
            <onb-element model="[[model]]"></onb-element>
        </template>
        <div class="absolute-bottom-right">
            <a href="/add-cloud">
                <paper-fab id="addBtn" icon="cloud"></paper-fab>
            </a>
        </div>

        <div class="is-loading" hidden$="[[!onboarding.isLoadingClouds]]">
            <paper-spinner active></paper-spinner>
        </div>
    </template>
</dom-module>
<script>

Polymer({
    is: 'page-dashboard',
    enableCustomStyleProperties: true,
    properties: {
        sections: {
            type: Object
        },
        model: {
            type: Object
        },
        q: {
            type: String,
            notify: true
        },
        dashboard: {
            type: Object
        },
        replaceTargets: {
            type: Object,
            computed: '_computeReplaceTargets(model.monitoring)'
        },
        openedCloud: String,
        showDashboard: {
            type: Boolean,
            // value: true,
            computed: '_computeshowDashboard(model.cloudsArray.length, onboarding.isLoadingClouds)',
            notify: true
        },
        hasIncidents: {
             type: Boolean,
             computed: '_computeHasIncidents(model.incidents.*)',
             value: false
        },
        sidebarIsOpen: {
            type: Boolean,
            value: true
        },
        matrix: Array
    },
    observers: [
        'cloudLayoutMatrix(model.clouds.*, sidebarIsOpen)'
    ],
    listeners: {
        'close-cloud-info': '_closeCloudChips'
    },
    ready: function() {
    },
    attached: function() {
        // reset page title since this is the default page
        this.fire('page-meta', {
            title: null
        });
        this.datasources = [
          {
          "id": 1,
          "orgId": 1,
          "name": "mistphite",
          "type": "graphite",
          "access": "proxy",
          "uri": "/graphite/",
          "password": "",
          "user": "",
          "database": "",
          "basicAuth": false,
          "basicAuthUser": "",
          "basicAuthPassword": "",
          "withCredentials": false,
          "isDefault": false,
          "jsonData": null
          }
        ];
        this.dashboard = {
          "id": 1,
          "refresh": "10s",
          "rows": [{
            "panels": [{
              "aliasColors": {},
              "datasource": "mistphite",
              "id": 2,
              "span": 12,
              "stack": false,
              "targets": [
                {
                "refId": "A",
                "target": "bucky.*.load.shortterm"
                },
              ],
              "timeFrom": null,
              "timeShift": null,
              "title": "Load on all monitored machines",
              "type": "graph",
              "x-axis": true,
              "y-axis": true
            }],
          }],
          "time": {
            "from": "now-10m",
            "to": "now"
          },
          "timepicker": {
            "now": true,
            "refresh_intervals": [],
            "time_options": [
              "5m",
              "15m",
              "1h",
              "6h",
              "12h",
              "24h",
              "2d",
              "7d",
              "30d"
            ]
          },
          "timezone": "browser"
        };

        var that = this;
        setInterval(function(){ // FIXME: find a better way to fix broken chart width when coming from another page
            if (that.querySelector('dashboard-panel'))
                that.querySelector('dashboard-panel').resize();

        }, 5000);
        //this.cloudLayoutMatrix();
    },
    isOnline: function(cloud) {
        return cloud.state == 'online' && 'online';
    },
    isOffline: function(cloud) {
        return cloud.state == 'offline' && 'offline';
    },
    _computeHasIncidents: function(incidents){
         if (incidents.base && incidents.base.length > 0){
            var unclosedInc = incidents.base.find(function(inc){
                return !inc.finished_at;
            });
            return unclosedInc ? true : false;
         }
         else {
             return false;
         }
     },
    _computeshowDashboard: function(cloudslength, isLoadingClouds) {
        var show;
        if (cloudslength > 0 && isLoadingClouds == false) {
            show =  true;
        }
        else {
            show = false;
            // TODO: does not work. hides no matter
            // this.hideSidebar();
        }
        return show;
    },
    hideSidebar: function(){
        // if we are on boarding, close sidebar for focus
        window.setTimeout(function(){
            var sidebar = document.querySelector('app-sidebar'),
                content = document.querySelector('iron-pages');
            sidebar.classList.add('close');
            content.classList.add('center');
        }, 2400);
        this.set('sidebarIsOpen', false);
    },
    _computeProviderLogo: function(className) {
        return '../assets/providers/provider-' + className.split('_')[0] + '.png';
    },
    _computeReplaceTargets: function(monitoring) {
        var ret = {'bucky.': ''},
            mIds = Object.keys(this.get('model.monitoring.monitored_machines') || {});
        for (var i=0; i<mIds.length; i++) {
            var mref = this.model.monitoring.monitored_machines[mIds[i]],
                m = mref && this.model.clouds[mref.cloud_id].machines[mref.machine_id];
            ret[mIds[i]] = m ? m.name : 'unknown';
        }
        return ret;
    },
    _showCloudInfoDialog: function(e) {
        var cloudId = e.currentTarget.getAttribute('id');
        var dialog = this.querySelector('cloud-info');
        var parent = this.querySelector('#cloudslist');
        var target = e.currentTarget;
        var lastInd = this.indexOfLast(parseInt(target.attributes.index.value))

        // find the cloud chip node with index=lastInd
        var last = [].find.call(parent.children, function(c, index){
            if (c.attributes.index) {
                return c.attributes.index.value == lastInd;
            }
            return false;
        });
        //insert cloud-info before last node
        Polymer.dom(parent).insertBefore(dialog, last);

        if (this.openedCloud && this.openedCloud == cloudId) {
            dialog.removeAttribute('opened');
            this._closeCloudChips();            
        }
        else {
            var cloudChips = this.querySelectorAll('cloud-chip'),
                cloud = this.model.cloudsArray.find(function(cloud) {
                    return cloud.id == cloudId;
                });
            [].forEach.call(cloudChips, function(el, index) {
                if (el == e.currentTarget){
                    el.setAttribute('opened', true)
                }
                else {
                    el.removeAttribute('opened');
                }
            });
            this.set('openedCloud', cloudId);
            dialog.cloud = cloud;
            dialog.setAttribute('opened', true);
        }
    },
    _closeCloudChips: function(){
        var cloudChips = this.querySelectorAll('cloud-chip');
        [].forEach.call(cloudChips, function(el, index) {
            el.removeAttribute('opened');
        });
        this.set('openedCloud', '');
    },
    showSidebar: function(){
        //show sidebar for navigation
        window.setTimeout(function(){
            var sidebar = document.querySelector('app-sidebar'),
                content = document.querySelector('iron-pages');
            sidebar.classList.remove('close');
            content.classList.remove('center');
        }, 200);
        this.set('sidebarIsOpen', true);
    },
    cloudLayoutMatrix: function(clouds, sidebarOpen){
        //construct a reference matrix of the chips offsetTops
        var chips = document.querySelectorAll('cloud-chip');
        var matrix = [];
        if(chips) {
            [].forEach.call(chips, function(c){
                matrix.push(c.offsetTop);
            });
            this.set('matrix', matrix);
        }
    },
    indexOfLast: function(index){
        //calculate the index of the first chip of the next row
        var ref = this.matrix[index];
        var targetIndex;
        var nextInd = this.matrix.find(function(n, index){
            targetIndex = index;
            return n > ref;
        }, this);
        // or if the first chip of the next row does not exist, set index to the last chip
        if (!nextInd){
            targetIndex = this.matrix.length
        }
        return targetIndex;
    },
    _toggleUI: function() {
        window.location.href = '/toggle-ui/legacy';
    },
});
</script>
f