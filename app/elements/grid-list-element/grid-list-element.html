<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<dom-module id="grid-list-element">
    <template>
        <style is="custom-style" include="lists"></style>
        <style is="custom-style" include="shared-styles">


        /* vaadin grid specifc styling */
        vaadin-grid {
            --default-primary-color: var(--mist-blue);
        }
          /* Input styles */
  vaadin-grid ::content input[type="checkbox"] {
    position: absolute;
    opacity: 0;
  }

  vaadin-grid ::content input[type="checkbox"] + label {
    position: relative;
    left: 0;
    box-sizing: border-box;
    display: block;
    width: 18px;
    height: 18px;
    border: 2px solid #7a7a7a;
    border-radius: 2px;
    cursor: pointer;
    transition: background-color 120ms, border-color 120ms;


    background-color: #ddd;
    border: 0 none !important;
    border-radius: 50% !important;
    width: 24px !important;
    height: 24px !important;

  }

  vaadin-grid ::content input[type="checkbox"]:focus {
    outline: none;
  }

  vaadin-grid ::content input[type="checkbox"] + label:after {
    content: url(img/tick.svg);
    position: absolute;
    top: -1px;
    left: -1px;
    display: block;
    width: 16px;
    height: 17px;
    transition: all 200ms;
    -webkit-transform: scale(0);
    transform: scale(0);
    -webkit-transform-origin: 40% 80%;
    transform-origin: 40% 80%;


    top: 4px !important;
    left: 4px !important;
  }

  vaadin-grid :;content input[type="checkbox"]:checked + label {
    background-color: var(--default-primary-color, #03A9F4);
    border-color: transparent;
  }

  vaadin-grid ::content input[type="checkbox"]:checked + label:after {
    -webkit-transform: scale(1);
    transform: scale(1);
  }

  vaadin-grid ::content input[type="checkbox"]:indeterminate + label:after {
    content: "â€“";
    font-family: arial;
    font-weight: bold;
    font-size: 14px;
    line-height: 1;
    text-align: center;
    -webkit-transform: scale(1);
    transform: scale(1);
    transition: none;
  }


  /* Activation "splash" */
  vaadin-grid ::content input[type="checkbox"] + label:before {
    content: "";
    position: absolute;
    /*top: -13px;
    left: -13px;*/
    width: 41px;
    height: 41px;
    border-radius: 50%;
    background-color: #666;
    opacity: 0;
    -webkit-transform: scale(0.8);
    transform: scale(0.8);
    transition: all 180ms cubic-bezier(0.75,.0,0.25,1);

    top: -9px !important;
    left: -9px !important;
  }

  vaadin-grid ::content input[type="checkbox"] + label:active:before {
    transform: scale(1.1);
    opacity: 0.15;
    transition-duration: 80ms;
    transition-property: all;
  }

  input[type="checkbox"]:checked + label:before {
    background-color: var(--default-primary-color, #03A9F4);
  }


        :host {
            display: block;
            background: #fafafa;
        }

        paper-card {
            display: block;
        }

        #container {
            background: #fafafa;
        }

        .paper-header [paper-drawer-toggle] {
            margin-left: 10px;
        }

        .paper-header {
            @apply(--layout-horizontal);
        }

        .paper-header {
            height: 60px;
            font-size: 24px;
            line-height: 60px;
            padding: 0 10px;
            color: white;
            transition: height 0.2s;
            transition: font-size 0.2s;
        }

        .paper-header.tall {
            height: 320px;
            font-size: 16px;
        }

        .paper-header h2 {
            margin-left: 20px;
            @apply(--layout-flex);
            text-transform: capitalize;
        }

        #content {
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0 10px;
        }

        paper-icon-button {
            transition: all 200ms;
        }

        paper-icon-button.active-sort {
            transform: rotate(180deg);
        }

        paper-icon-button.active-sort::content iron-icon {
            color: #D48900 !important;
        }

        app-bar .menu-icon {
            margin-right: 15px;
        }

        app-check {
            margin-right: 16px;
            display: inline-block;
            vertical-align: middle;
        }

        [size=xs] > * {
            display: none;
        }

        [size=xs] app-sidebar {
            min-width: 100%;
            height: auto;
        }

        .absolute-top-right {
            position: fixed;
            right: 18px;
            top: 305px;
            z-index: 10;
        }
        </style>
        <paper-drawer-panel id="drawerPanel" responsive-width="900px" narrow="{{narrowMode}}" drawer-width="272px" disable-edge-swipe selected="[[section]]">
            <app-sidebar model="[[model]]" tag="[[tag]]" sections="[[sections]]" current="[[section.id]]" drawer></app-sidebar>
            <paper-header-panel id="container" mode="waterfall-tall" view$="[[_actualView(view)]]" main>
                <paper-toolbar class="tall" style$="[[_getHeaderStyle(section.color)]]">
                    <paper-icon-button icon="icons:arrow-back"></paper-icon-button>
                    <span class="title"></span>
                    <app-user-menu email="[[model.email]]"></app-user-menu>
                    <span class="bottom title">[[presentedScripts.length]] Scripts</span>
                </paper-toolbar>
                <div class="list">
                    <div hidden$="[[!hasScripts]]" class="list-options">
                        <div class$="option search [[showSearchOption]]">
                            <paper-icon-button id="searchScriptBtn" icon="search" on-tap="_toggleSearchSelected"></paper-icon-button>
                            <paper-input hidden$="[[!showSearchOption]]" type="search" value="{{searchTerm}}" placeholder="" no-label-float class="search"></paper-input>
                            <paper-icon-button hidden$="[[!showSearchOption]]" icon="close" on-tap="_toggleSearchSelected"></paper-icon-button>
                            <span hidden$="[[showSearchOption]]" class="label">Search scripts</span>
                        </div>
                        <paper-tooltip for="runScriptBtn" position="bottom">Run Script</paper-tooltip>
                        <paper-icon-button id="runScriptBtn" hidden$="[[!showRunOption]]" on-tap="_runSelected" icon="schedule"></paper-icon-button>
                        <paper-tooltip for="editScriptBtn" position="bottom">Edit</paper-tooltip>
                        <paper-icon-button id="editScriptBtn" hidden$="[[!showEditOption]]" on-tap="_editSelected" icon="image:edit"></paper-icon-button>
                        <paper-tooltip for="deleteScriptBtn" position="bottom">Delete</paper-tooltip>
                        <paper-icon-button id="deleteScriptBtn" hidden$="[[!showDeleteOption]]" on-tap="_deleteSelected" icon="delete"></paper-icon-button>
                        <span hidden$="[[!showDeleteOption]]" class="label">
                        Delete [[selectedScripts.length]] script<span hidden$="[[!moreThanOneSelected]]">s</span> </span>
                        </span>
                    </div>
                    <vaadin-grid id="grid" selection-mode="multi">
                        <table>
                            <colgroup>
                                <col name="name" sortable>
                                <col name="source" sortable>
                                <col name="type" sortable>
                            </colgroup>
                        </table>
                    </vaadin-grid>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
        <script-edit-element script="[[selectedScript]]"></script-edit-element>
        <dialog-element></dialog-element>
    </template>
    <script>
    (function() {
        'use strict';

        Polymer({
            is: 'grid-list-element',

            properties: {
                scripts: {
                    type: Array
                },
                selectedScripts: {
                    type: Array
                },
                selectedScript: {
                    type: Object,
                    value: null
                },
                moreThanOneSelected: {
                    type: Boolean,
                    value: false
                },
                clouds: {
                    type: Array
                },
                hasScripts: {
                    type: Boolean,
                    value: function(scripts) {
                        return scripts.length > 0;
                    }
                },
                showEditOption: {
                    type: Boolean,
                    value: false
                },
                showRunOption: {
                    type: Boolean,
                    value: false
                },
                showDeleteOption: {
                    type: Boolean,
                    value: false
                },
                showSearchOption: {
                    type: Boolean,
                    value: false
                },
                searchTerm: {
                    type: String,
                    value: '',
                    notify: true
                }
            },
            observers: [
                '_scriptsChanged(scripts.*, selectedScripts.*)',
                '_filterScripts(scripts.*, searchTerm)'
            ],
            listeners: {
                'toggleSelectedScript': '_toggleSelectedScript',
                'addScript': '_addScript',
                'updateSelectedScript': '_updateSelectedScript',
                'confirmation': '_deleteSelectedResponse'
            },
            ready: function() {
                this.$.grid.set('items', this.scripts);
                this.listen(this.$.grid, "sort-order-changed", "_sortOrderChanged");
                this.listen(this.$.grid, "selected-items-changed", "_selectedItemsChanged");
            },
            _getHeaderStyle: function(color) {
                return 'background-color: ' + color + '; color: #fff;';
            },
            _filterScripts: function(scripts, searchTerm) {
                this.$.grid.items = this.scripts.filter(function(script) {
                    var name = script.name.toLowerCase();
                    return name.indexOf(searchTerm) != -1;
                });
            },
            _sortOrderChanged: function(e) {
                var sortOrder = grid.sortOrder[0],
                    sortProperty = grid.columns[sortOrder.column].name,
                    sortDirection = sortOrder.direction;
                grid.items.sort(function(a, b) {
                    var res;
                    var path = sortProperty.split('.');
                    for (var i = 0; i < path.length; i++) {
                        a = a[path[i]];
                        b = b[path[i]];
                    }
                    if (!isNaN(a)) {
                        res = parseInt(a, 10) - parseInt(b, 10);
                    } else {
                        res = a.localeCompare(b);
                    }

                    if ('desc' === sortDirection) {
                        res *= -1;
                    }
                    return res;
                });
            },
            _selectedItemsChanged: function(e) {
                var selected = grid.selection.selected(),
                    selectedScripts = this.scripts.filter(function(script, index) {
                        return selected.indexOf(index) > -1;
                    });
                this.set('selectedScripts', selectedScripts);
            },
            _scriptsChanged: function(scripts, selectedScripts) {
                this.set('showDeleteOption', selectedScripts.base.length > 0);

                this.set('selectedScript', selectedScripts.base.length == 1 ? selectedScripts.base[0] : null);

                this.set('showRunOption', selectedScripts.base.length == 1);

                this.set('showEditOption', selectedScripts.base.length == 1);

                this.set('moreThanOneSelected', selectedScripts.base.length > 1);

                this.set('hasScripts', scripts.base.length > 0);
            },
            _toggleSearchSelected: function() {
                var showSearchOption = !this.showSearchOption;
                this.set('showSearchOption', showSearchOption);

                if (!showSearchOption) {
                    this.set('searchTerm', '');
                }
            },
            _deleteSelected: function(e) {
                this._showDialog({
                    title: this._formatTitle(),
                    body: this._formatBody(),
                    danger: true,
                    reason: "delete_scripts"
                });
            },
            _deleteSelectedResponse: function(e) {
                var reason = e.detail.reason,
                    response = e.detail.response;

                if (response.confirmed && reason == "delete_scripts") {
                    this._showNotification(this.selectedScripts.length > 1 ? 'Scripts were deleted!' : 'Script was deleted!');

                    this.selectedScripts.forEach(function(el, index) {
                        var index = this.scripts.indexOf(el);
                        grid.selection.deselect(index);
                        this.splice('scripts', index, 1);
                    }, this);
                    grid.size = this.scripts.length;
                    grid.refreshItems();
                }
            },
            _editSelected: function(e) {
                var el = this.querySelector('script-edit-element');
                el._openEditScriptModal();
            },
            _runSelected: function(e) {
                page.show('/run-script/' + this.selectedScript.id);
            },
            _updateSelectedScript: function(e) {
                var script = e.detail.script,
                    index = this.scripts.indexOf(script);
                this.set('scripts.' + index + '.name', script.name);
                this.set('scripts.' + index + '.description', script.description);
            },
            _openAddScriptPage: function(e) {
                page.show('/add-script');
            },
            _addScript: function(e) {
                var script = e.detail.script;
                this.push('scripts', script);
            },
            _showDialog: function(info) {
                var dialog = this.querySelector('dialog-element'),
                    i;
                for (i in info) {
                    dialog[i] = info[i];
                }
                dialog._openDialog();
            },
            _formatTitle: function() {
                return this.selectedScripts.length > 1 ? "Delete Scripts" : "Delete Script";
            },
            _formatBody: function() {
                var selectedScripts = this.selectedScripts,
                    names = selectedScripts
                    .map(function(script) {
                        return script.name;
                    })
                    .join(', ');

                return (selectedScripts.length > 1 ? "Are you sure you want to delete these scripts: " : "Are you sure you want to delete this script: ") + names + "?";
            },
            _showNotification: function(title) {
                var notification = document.querySelector('notification-element');
                notification.title = title;
                notification._openToast();
            }
        });
    })();
    </script>
</dom-module>
