<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../app-icons/app-icons.html">
<link rel="import" href="../app-form/app-form.html">

<dom-module id="script-run">
    <template>
        <style is="custom-style" include="forms"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
        :host {
            display: block;
        }
        p {
            padding: 0 !important;
        }
        #content {
            max-width: 900px;
        }
        paper-material {
            display: block;
            padding: 24px;
        }

        paper-progress {
            position: absolute;
            bottom: 85px;
            width: 100%;
            left: 0;
            right: 0;
        }

        :host >::content paper-input-container {
            padding-top: 16px;
            padding-bottom: 16px;
        }

        .error {
            color: var(--red-color);
        }
        .error iron-icon {
            color: inherit;
        }
        </style>

        <div id="content">
            <paper-material class="single-head layout horizontal" style$="background-color: [[section.color]]">
                <span class="icon"><iron-icon icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        Run Script '[[script.name]]
                    </h2>
                    <div class="subtitle">
                        You can currently run scripts on one machine per time. You will soon be able to schedule your scripts to run.
                    </div>
                </div>
            </paper-material>
            <paper-material>
                <p>
                    Heads up! Make sure you select a machine you have already associated a key with. Otherwise the the request may be accepted but the script will never finish run.
                </p>
                <p class="error" hidden$="[[machineHasKeys]]">
                    <iron-icon icon="icons:warning"></iron-icon> Machine [[machine.name]] has no associated keys. 
                </p>
                <app-form fields="[[fields]]" url="/api/v1/scripts/[[params.id]]" on-response="_runScriptResponse" btncontent="run"></app-form>
            </paper-material>
        </div>
        <paper-toast id="run-script-toast"></paper-toast>
    </template>

    <script>
        (function() {
            'use strict';

            Polymer({
                is: 'script-run',

                properties: {
                    model: Object,
                    params: Object,
                    script: {
                        type: Object,
                        computed: '_computeScript(params, model.scriptsArray.*)'
                    },
                    section: Object,                    
                    fields: {
                        type: Array,
                    },
                    parameters: {
                        type: String,
                        value: null
                    },
                    machinesOptions: {
                        type: Array,
                        value: []
                    },
                    hasMachines: {
                        type: Boolean,
                        computed: '_computeHasMachines(machinesOptions.*)'
                    },
                    cardTitleText: {
                        type: String,
                        computed: '_computeCardTitleText(script.name, runScript.machine)'
                    },
                    machine: Object,
                    machineHasKeys: {
                        type: Boolean,
                        value: true,
                        computed: '_machineChanged(machine)'
                    }
                },
                observers: [
                    '_cloudsChanged(model.cloudsArray.*, model.machinesArray.*)'
                ],
                listeners: {
                    'iron-select': '_fieldsChanged'
                },
                _computeScript: function(params, model) {
                    var script = this.model.scriptsArray.find(function(script) {
                        return script.id == this.params.id;
                    },this);
                    return script;
                },
                _computeMachinesOptions: function(clouds) {
                    return this.model.machinesArray.filter(function(cloud) {
                            return cloud.enabled;
                        });
                },
                _computeHasMachines: function(machinesOptions) {
                    return machinesOptions.base.length > 0;
                },
                _computeFieldType: function(field, value, show) {
                    if (!(field.showIf && !field.show)) {
                        return field.type == value;
                    }
                },
                _computeCardTitleText: function(name, machine) {
                    return machine ? 'Run Script "' + name + '" on "' + machine.name + '"' : 'Run Script "' + name + '"';
                },
                _fieldsChanged: function() {
                    var machine = this.fields.find(function(f){
                        return f.name.startsWith("machine");
                    });
                    var cloud = this.fields.find(function(f, index){
                        return f.name.startsWith("cloud");
                    }); 
                    if (machine && machine.value) {
                        var machineID = machine.value;
                        var machineCloud = this.model.machinesArray.find(function(m){
                            return m.id == machineID;
                        });
                        this.set("machine", machineCloud);
                        this.set('fields.1.value', machineCloud.cloud.id);
                    };

                },
                _machineChanged: function(machine){
                    if (machine){
                        var machineID = machine.id;
                        var key = this.model.keysArray.find(function(k){
                            return k.machines.find(function(m){
                                return m[1] == machineID;
                            })
                        });

                        if (key){
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                },
                _cloudsChanged: function(clouds) {
                    var fields = [{
                            name: "machine_id",
                            label: "Select Machine *",
                            type: "mist_dropdown",
                            value: "",
                            defaultValue: "",
                            placeholder: "",
                            helptext: "Choose the machine on which the script will run",
                            show: true,
                            required: true,
                            options: this.model.machinesArray
                        }, {
                            name: "cloud_id",
                            label: "Cloud ID",
                            type: "text",
                            value: "",
                            defaultValue: "",
                            placeholder: "",
                            helptext: "The cloud ID of the machine.",
                            show: false,
                            showIf: {
                                fieldName: "machine_id",
                                fieldExists: true
                            },
                            required: true,
                            disabled: true
                        }, {
                            name: "params",
                            label: "Parameters",
                            type: "textarea",
                            value: "",
                            defaultValue: "",
                            placeholder: "",
                            helptext: "Optional. Fill in the scripts pareameters.",
                            errorMessage: "Please enter network's name",
                            show: true,
                            required: false
                         }];
                    this.set('fields', fields)
                },
                _runScriptResponse: function(e) {
                    var msg = 'Run script request was successfull. Redirecting to script...';
                    this._showToast(msg);
                    this.async(function(){
                        page('/scripts/'+this.script.id);
                    }, 3300)
                },
                _showToast: function(msg) {
                    var toast = this.querySelector('paper-toast#run-script-toast');
                    toast.text = msg;
                    toast.show();
                }
            });
        })();
    </script>
</dom-module>
