<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../helpers/dialog-element.html">
<link rel="import" href="../tags/tags-list.html">

<link rel="import" href="tunnel-edit.html">
<!-- <link rel="import" href="script-run.html"> -->

<dom-module id="tunnel-page">
    <template>
        <style is="custom-style" include="single-page"></style>
        <style is="custom-style" include="tags-and-labels"></style>
        <style include="shared-styles">
        :host {
            display: block;
        }
        .columns {
            @apply(--layout-horizontal);
            flex: 1 100%;
        }
        .left, .right {
            @apply(--layout-vertical);
            align-items: flex-start;
            flex-direction: column;
            flex: 1 100%;
            overflow: hidden;
        }
        .left {
            flex: 1 60%;
        }
        .right {
            flex: 1 40%;
        }
        paper-material {
            display: block;
            padding: 20px;
            overflow: hidden;
        }

        paper-menu-button paper-button {
            display: block;
        }

        .flex-horizontal-with-ratios {
            @apply(--layout-horizontal);
        }

        .flexchild {
            @apply(--layout-flex);
        }

        .command-container {
            background-color: #444;
            color: #fff;
            font-family: monospace;
            padding: 10px;
            width: 100%;
            max-width: 100%;
            overflow-x: scroll;
            box-sizing: border-box;
        }

        a {
            color: black;
            text-decoration: none;
        }

        paper-icon-button {
            transition: all 200ms;
        }

        [size=xs] > * {
            display: none;
        }

        [size=xs] app-sidebar {
            min-width: 100%;
            height: auto;
        }

        h4.id {
            display: inline-block;
            text-transform: uppercase;
            font-size: 0.9rem;
            font-weight: 700;
            margin-right: 16px;
        }
        .id {
            display: inline-block;
        }
        /* TODO: better */
        .tag {
            padding: 0.5em;
            display: inline-flex;
            align-self: center;
        }
        .info-table {
            border-top: 1px solid #ddd;
        }
        #leftcolumn {
            position: relative;
        }
        #getcurl,
        #getscript,
        #copycurl,
        #copyscript {
            display: none;
            background-color: rgba(255, 255, 255, 0.15);
            color: inherit;
            font-size: 13px;
        }
        #getcurl iron-icon,
        #getscript iron-icon,
        #copycurl iron-icon,
        #copyscript iron-icon {
            color: inherit;
            margin-right: 8px;
        }
        #getcurl,
        #getscript {
            display: inline-block;
        }
        #copycurl[show],
        #copyscript[show] {
            display: inline-block;
        }
        .is-loading {
            top: 15px;
            left: 200px;
            position: fixed;
            right: 0;
            bottom: 0;
            display: block;
            width: 100%;
            height: 100vh;
            background-color: #eee;
        }
        .is-loading paper-spinner {
            width: 80px;
            height: 80px;
            margin: 10% auto;
            display: block;
        }
        </style>

        <div id="content">
            <div class="is-loading" hidden$="[[!isLoading]]">
                <paper-spinner active hidden$="[[!isLoading]]"></paper-spinner>
            </div>
            <paper-material class="single-head layout horizontal" style$="background-color: [[section.color]]">
                <span class="icon"><iron-icon icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        [[tunnel.name]]
                    </h2>
                    <div class="subtitle">
                        <span>[[tunnel.description]]</span>
                    </div>
                </div>
                <div class="item-actions">
                    <paper-button on-tap="_editTags" class="simple">tags</paper-button>
                    <paper-menu-button horizontal-align="right">
                        <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                        <paper-menu id="machine_actions" class="dropdown-content">
                            <paper-button on-tap="_disableTunnel" class="simple" hidden$="[[!tunnel.active]]" disabled>Disable Tunnel</paper-button>
                            <paper-button on-tap="_editTunnel" class="simple">Edit Tunnel</paper-button>
                            <paper-button on-tap="_deleteTunnel" class="simple">Delete Tunnel</paper-button>
                        </paper-menu>                        
                    </paper-menu-button>
                    <paper-button on-tap="_enableTunnel" class="simple white right-icon" style$="color: [[section.color]]" hidden$="[[tunnel.active]]" disabled> Enable Tunnel <iron-icon icon="av:play-arrow" style$="color: [[section.color]]"></iron-icon></paper-button>
                </div>
            </paper-material>
            <div class="columns">
                <div id="leftcolumn" class="left command-container">
                    <div class="pad2">
                        <pre><code>
Options for installing your VPN client:

1.  Via `curl`: Hit the button below in order to be provided with 
    a simple `curl` command, which you can directly run in your shell 
    and will take care of installing the VPN client. This is the 
    recommended option, especially if you are not planning on modifying 
    the configuration script provided.

2.  Alternatively, you can request and then copy &amp; paste the configuration 
    script in your shell, make it executable, and run it. This option is 
    useful in case you want to make any changes to the configuration provided.
</code></pre>
                        <pre><code>
==============================================================================
CURL Command:</code></pre>
                        <pre><code id="tunnelscommand"></code></pre>
                        <paper-button id="copycurl" on-tap="copyCurl" class="pull-right link"> <iron-icon icon="content-copy"> </iron-icon>Copy command</paper-button>
                        <paper-button id="getcurl" on-tap="_requestCommand" class="pull-right link"> <iron-icon icon="content-copy"> </iron-icon>Request command</paper-button>
                        <pre><code>
==============================================================================
Script:</code></pre>
                        <pre><code id="tunnelscript"></code></pre>
                        <paper-button id="getscript" handle-as="json" on-tap="_requestScript" class="pull-right link"><iron-icon icon="content-copy"></iron-icon> Request Script</paper-button>
                        <paper-button id="copyscript" on-tap="copyScript" class="pull-right link"><iron-icon icon="content-copy"></iron-icon> Copy Script </paper-button>
                        <pre><code>
                            
                        </code></pre>
                    </div>
                </div>
                <paper-material id="rightcolumn" class="right">
                <div class="info-table">
                    <div class="info-body info-group">
                        <div class="info-item flex-horizontal-with-ratios">
                            <div class="flexchild">ID</div>
                            <div class="flexchild">[[tunnel.id]]</div>
                        </div>
                        <div class="info-item flex-horizontal-with-ratios">
                            <div class="flexchild">TUNNEL ID</div>
                            <div class="flexchild">[[tunnel.tunnel_id]]</div>
                        </div>
                        <template is="dom-if" if="[[tunnel.tags.length]]">
                            <div class="info-item flex-horizontal-with-ratios">
                                <h4 class="id tags">TAGS
                                    <template is="dom-if" if="[[tunnel.tags]]">
                                        <span class="id">[[tunnel.tags]]</span>
                                    </template>
                                    <template is="dom-if" if="[[!tunnel.tags]]">
                                        <span class="id">(0)</span>
                                    </template>
                                </h4>
                                <template is="dom-if" if="[[tunnel.tags]]">
                                    <template is="dom-repeat" items="[[tunnel.tags]]">
                                        <span class="id tag">[[item.key]]<span hidden="[[!item.value]]">=[[item.value]]</span></span>
                                    </template>
                                </template>
                            </div>
                        </template>
                        <div class="info-item flex-horizontal-with-ratios">
                            <div class="flexchild">CIDRS</div>
                            <div class="flexchild">
                                <template is="dom-repeat" items=[[tunnel.cidrs]]>
                                    [[item]]<br/>
                                </template>
                            </div>
                        </div>
                        <div class="info-item flex-horizontal-with-ratios">
                            <div class="flexchild">Port</div>
                            <div class="flexchild">[[tunnel.port]]</div>
                        </div>
                        <div class="info-item flex-horizontal-with-ratios">
                            <div class="flexchild">Enabled</div>
                            <div class="flexchild">[[tunnel.active]]</div>
                        </div>
                    </div>
                </div>
            </paper-material>
            </div>
            <!-- <div class="absolute-bottom-right">
                <paper-fab icon="av:play-arrow" on-tap="_runScript" id="runScriptFab"></paper-fab>
                <paper-tooltip for="runScriptFab" position="top">Run Script</paper-tooltip>
            </div> -->
        </div>
        <tunnel-edit tunnel="[[tunnel]]"></tunnel-edit>
        <iron-ajax id="tunnelDeleteAjaxRequest" url="/api/v1/tunnels/[[tunnel.id]]" method="DELETE" on-response="_handleTunnelDeleteAjaxResponse" on-error="_handleTunnelDeleteAjaxError"></iron-ajax>
        <iron-ajax id="scriptAjaxRequest" url="/api/v1/tunnels/[[tunnel.id]]/script" method="GET" on-response="_handleScriptAjaxRequest" on-error="_handleScriptAjaxError"></iron-ajax>
        <iron-ajax id="commandAjaxRequest" url="/api/v1/tunnels/[[tunnel.id]]/command" method="GET" on-response="_handleCommandAjaxRequest" handle-as="xml" on-error="_handleCommandAjaxError"></iron-ajax>
        <script-edit script="[[script]]"></script-edit>
        <dialog-element></dialog-element>
        <tags-list resource="tunnel"></tags-list>
        <paper-toast></paper-toast>
    </template>
    <script>
    (function() {
        'use strict';

        Polymer({
            is: 'tunnel-page',

            properties: {
                sections: {
                    type: Object
                },
                section: {
                    type: Object
                },
                color: {
                    type: String,
                    computed: '_getHeaderStyle(section)'
                },
                params: {
                    type: Object
                },
                model: {
                    type: Object
                },
                tunnel: {
                    type: Object,
                    computed: '_computeTunnel(params, model.tunnelsArray.*)'
                },
                tunnelid: {
                    type: String,
                    computed: '_computeTunnelId(params)'
                },
                isInline: {
                    type: Boolean,
                    value: true
                },
                isLoading: {
                    type: Boolean,
                    computed: '_computeIsloading(tunnel)',
                    value: true
                }
            },
            observers: [
                "_updateCommandArea(tunnel.id)"
            ],
            listeners: {
                'confirmation': '_deleteTunnelEventResponse',
                'updateSelectedScript': '_updateScript'
            },
            _updateCommandArea: function(id){
                this.$.tunnelcommand.textContent = '';
                this.$.tunnelscript.textContent = '';
                this.$.copyscript.removeAttribute('show');
                this.$.copycurl.removeAttribute('show');
            },
            _getHeaderStyle: function(section) {
                return 'background-color: ' + section.color + '; color: #fff;';
            },
            _computeId: function(params) {
                return params.id;
            },
            _computeTunnel: function(params, tunnels) {
                return tunnels.base.find(function(tunnel) {
                    return tunnel.id == params.id;
                });
            },
            _computeTunnelId: function(params) {
                return params.id;
            },
            _computeIsInline: function(location_type) {
                if (location_type)
                    return location_type == 'inline';
                else
                    return true;
            },
            _editTags: function() {
                var el = this.querySelector('tags-list'),
                items = [];
                items.push(this.tunnel);
                el.items = items;
                el._openDialog();
            },
            _runScript: function(e) {
                page.show('/run-script/' + this.tunnel.id);
            },
            _editTunnel: function(e) {
                var el = this.querySelector('tunnel-edit');
                el._openEditTunnelModal();
            },
            _updateScript: function(e) {
                var tunnel = e.detail.tunnel;
                this.set('tunnel.name', tunnel.name);
                this.set('script.description', script.description);
            },
            _deleteTunnel: function(e) {
                this._showDialog({
                    title: 'Delete Tunnel?',
                    body: "Deleting tunnels cannot be undone. You are about to delete tunnel: '" + this.tunnel.name + "'." ,
                    danger: true,
                    reason: "tunnel.delete"
                });
            },
            _deleteTunnelEventResponse: function(e) {
                var reason = e.detail.reason,
                    response = e.detail.response;

                if (response.confirmed && reason == "tunnel.delete") {
                    this.$.tunnelDeleteAjaxRequest.body = {};
                    this.$.tunnelDeleteAjaxRequest.headers["Content-Type"] = 'application/json';
                    this.$.tunnelDeleteAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                    this.$.tunnelDeleteAjaxRequest.generateRequest();
                }
            },
            _handleTunnelDeleteAjaxResponse: function(e) {
                page.show('/tunnels');
            },
            _handleTunnelDeleteAjaxError: function(e) {
                var toast = this.querySelector('paper-toast');
                toast.text = "There was a problem deleting the tunnel";
                toast.show();
            },
            // script 
            _requestScript: function(){
                this.$.scriptAjaxRequest.body = {};
                this.$.scriptAjaxRequest.headers["Content-Type"] = 'application/json';
                this.$.scriptAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.scriptAjaxRequest.generateRequest();
            },
            _handleScriptAjaxRequest: function(e){
                console.log(e);
                var response = e.detail.response;
                if (e.detail.xhr.status == 200){
                    this.$.tunnelscript.textContent = response;
                    this.$.copyscript.setAttribute('show', true);
                }
            },
            _handleScriptAjaxError: function(e){
                
            },
            // command 
            _requestCommand: function(){
                this.$.commandAjaxRequest.body = {};
                this.$.commandAjaxRequest.headers["Content-Type"] = 'application/json';
                this.$.commandAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.commandAjaxRequest.generateRequest();
            },
            _handleCommandAjaxRequest: function(e){
                console.log(e);
                var response = e.detail.xhr.responseText;
                if (e.detail.type != "error"){
                    this.$.tunnelscommand.textContent = response;
                    this.$.copycurl.setAttribute('show', true);
                }
            },
            _handleCommandAjaxError: function(e){
                console.log(e);
                var response = e.detail.error;
                this.$.tunnelscommand.textContent = response;
            },
            _showDialog: function(info) {
                var dialog = this.querySelector('dialog-element');
                for (var i in info) {
                    dialog[i] = info[i];
                }
                dialog._openDialog();
            },
            copyScript: function(e) {
                this.clearSelection();
                var el = this.$.tunnelscript;
                this.setSelection(el);            
                var successful = document.execCommand('copy');
                var msg = successful ? 'The script was copied to clipboard!' : 'There was an error copying to clipboard!';

                this._showToast(msg);
            },
            copyCurl: function(e) {
                this.clearSelection();
                var el = this.$.tunnelscommand;
                this.setSelection(el);            
                var successful = document.execCommand('copy');
                var msg = successful ? 'The command was copied to clipboard!' : 'There was an error copying to clipboard!';

                this._showToast(msg);
            },
            _showToast: function(msg) {
                var toast = this.querySelector('paper-toast');
                toast.text = msg;
                toast.show();
            },
            _enableTunnel: function(){

            },
            _disableTunnel: function(){
                
            },
            clearSelection: function(){
                if (window.getSelection) {
                    if (window.getSelection().empty) {  // Chrome
                        window.getSelection().empty();
                    } else if (window.getSelection().removeAllRanges) {  // Firefox
                        window.getSelection().removeAllRanges();
                    }
                } else if (document.selection) {  // IE?
                    document.selection.empty();
                }
            },
            setSelection: function(el){
                if (document.selection) {
                    var range = document.body.createTextRange();
                        range.moveToElementText(el);
                    range.select();
                } else if (window.getSelection) {
                    var range = document.createRange();
                    range.selectNode(el);
                    window.getSelection().addRange(range);
                }
            },
            _computeIsloading(tunnel) {
                return !this.tunnel ? true : false;
            }
        });
    })();
    </script>
</dom-module>
