<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<dom-module id="app-incidents">
    <template>
        <style is="custom-style" include="headings"></style>
        <style>
        :host {
            display: flex;
            transition: var(--material-curve-320);
            transform: translate(0, 60px);
            opacity: 0;
            padding: 0;
            margin: 0;            
        }

        :host(.active) {
            transform: translate(0, 0);
            opacity: 1;
        }

        h3 {
            text-transform: uppercase;
            font-size: 13px;
            color: rgba(0, 0, 0, 0.54);
            padding: 0 10px;
            border-bottom: 1px solid #eee;
        }
        paper-material {
            overflow: hidden !important;
        }

        .list-item {
            border-bottom: 1px solid #eee;
            padding: 10px;
        }

        .list-item:last-child {
            border-bottom: 0 none;
            padding-top: 16px;
        }

        .list-item.red .machine {
            color: var(--red-color);
        }
        .list-item .expression > iron-icon {
            color: rgba(0,0,0,0.32);
            margin-right: 4px;
        }

        .list-item.red .expression > iron-icon {
            color: var(--red-color);
        }

        .list-item.green .expression > iron-icon {
            color: green;
        }

        .flexchild {
            @apply(--layout-flex);
        }
        .flex3child {
            @apply(--layout-flex-3);            
        }

        .block {
            transform: translate(0, 50px);
            opacity: 0;
            transition: all 700ms 320ms;
            transition-timing-function: var(--material-curve-320);
            display: flex;
            flex-direction: column;
            flex: 1 100%;
            height: inherit;
        }

        :host(.active) .block {
            transform: translate(0, 0);
            opacity: 1;
            height: 100%;
        }

        span.rule-condition {
            font-weight: normal;
        }

        span.time {
            float: right;
        }
        a.main-section {
            min-width: 150px;
        }
        </style>
        <div class="flexchild">
            <a href="/incidents" class="main-section" is="pushstate-anchor">
                <section-tile name="incidents" color="#d96557" icon="icons:error-outline" count="{{incidents.length}}" incidents></section-tile>
            </a>
        </div>
        <paper-material class="flex3child">
            <h3>Happening Now</h3>
            <div class="block">
                <template is="dom-repeat" items="{{incidents}}">
                    <!-- Only red incidents sould count and show. keep it temp/ly due to lacj of data -->
                    <!-- [[incidentColor(item)]] -->
                    <a class="list-item red layout horizontal wrap" href$="[[machineUri(item)]]">
                        <div class="flexchild expression">
                            <iron-icon icon="[[sections.machines.icon]]"></iron-icon>
                            <span class="machine flexchild">[[machineName(item)]]</span>: <span class="rule-condition">[[ruleCondition(item)]]</span>
                        </div>
                        <span class="time">
                            <template is="dom-if" if="[[!item.finished_at]]">
                                <sc-timeago datetime="[[incidentDuration(item)]]"></sc-timeago>
                            </template>
                            [[incidentTime(item)]]
                        </span>
                        <div>
                            <iron-icon icon="hardware:keyboard-arrow-right"></iron-icon>
                        </div>
                    </a>
                </template>
                <a class="list-item layout horizontal wrap" href="/incidents" hidden$="{{!resolvedCount}}">
                    <div class="flexchild expression">
                        <iron-icon icon="icons:report-problem"></iron-icon>
                        <span class="flexchild">and {{resolvedCount}} more incidents in the last day</span>
                    </div>
                    <span class="time">view all</span>
                    <div>
                        <iron-icon icon="hardware:keyboard-arrow-right"></iron-icon>
                    </div>
                </a>
            </div>
        </paper-material>
    </template>
</dom-module>
<script>
Polymer({
    is: 'app-incidents',
    properties: {
        title: {
            String, value: "Incidents"
        },
        model: {
            type: Object,            
            notify: true
        },
        incidents: {
            type: Array,
            value: [],
            notify: true
        },
        resolvedCount: {
            type: Number,
            notify: true
        },
        state: {
            String, value: "ONBOARD"
        },
        sections: {
            type: Object
        },
        whatTriggeredIt: {
            String, value: "#"
        }, // whatTriggeredIt will be func(machine,rule) to find url#anchore to the machine page and specific rule that trigered the alert
        alertstateclass: {
            String, value: "red"
        } // alert > red, resolved > green
    },
    observers: [
        '_incidents(model.incidents.*)',
        '_totalDuration(model.incidents.*)'
    ],
    attached: function() {
        var rows = this.parentNode.querySelectorAll('block');
        var index = Array.prototype.indexOf.call(rows, this);
        setTimeout(function() {
            this.classList.add('active');
        }.bind(this), (index + 1) * 50);
    },
    _incidents: function (incidents){
        var arr = incidents.base ? incidents.base : [];
        this.incidents = arr.filter(function(inc){
            return !inc.finished_at;
        });
        this.resolvedCount = incidents.base ? incidents.base.length - 1 : 0;
    },
    incidentColor: function(item){
        if (!item.finished_at)
            return 'red';
        return 'green';
    },
    incidentIcon: function(item) {
        if (!item.finished_at)
            return 'icons:report-problem';
        return 'icons:check';
    },
    machineName: function(item) {
        if (item.logs.length)
            return item.logs[0].machine_name;
        return this.model.clouds[item.cloud_id].machines[item.machine_id].name;
    },
    machineUri: function(item) {
        // console.log(this.model.clouds, item.cloud_id, this.model.incidents, this.model.monitoring);
        return '/machines/'  + item.machine_id;
    },
    ruleCondition: function(item) {
        return item.logs.length && item.logs[0].condition;
    },
    incidentDuration: function(item) {
        if (!item.finished_at)
            return new Date(item.started_at*1000)
        return new Date(item.started_at*1000)
        //return Date.now()-(item.finished_at-item.started_at)*1000;
    },
    incidentTime: function(item) {
        if (!item.finished_at)
            return 'for '
        return ''
    },
});
</script>
