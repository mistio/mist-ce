<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../app-rules/app-rules.html">
<link rel="import" href="../element-for-in/element-for-in.html">
<link rel="import" href="machine-edit.html">
<dom-module id="machine-page">
    <template>
        <style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="info-table-style"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
            :host {
                display: block;
            }
            .columns {
                @apply(--layout-horizontal);
                flex: 1 100%;
            }
            .left, .right {
                @apply(--layout-vertical);
                align-items: flex-start;
                flex-direction: column;
                flex: 1 100%;
            }
            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
                align-content: stretch;
                flex: 100%;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            .paper-header h2 {
                @apply(--layout-flex-none);
            }

            .machine-ip {
                margin: 0;
            }

            paper-material {
                padding: 24px;
                box-sizing: border-box;
                width: 100%;
            }
            paper-material.info-card {
                padding: 0;
            }
            paper-material > h2 {
                line-height: initial !important;
                margin-bottom: 0;
                cursor: pointer;
            }

            .subhead {
                box-sizing: border-box;
                position: absolute;
                width: 100%;
                left: 0;
                height: 57px;
                bottom: -57px;
                right: 0;
                z-index: 9;
                color: rgba(0, 0, 0, 0.87);
            }

            .status {
                padding-left: 16px;
                opacity: 0.54;
                font-size: 0.9em;
            }

            paper-header-panel::content #dropShadow {
                top: 56px;
            }

            paper-toolbar::content #bottomBar .right-actions {
                transition: var(--paper-toolbar-transition, margin-right 0.18s ease-in);
            }

            paper-toolbar:not(.tall)::content #bottomBar .right-actions {
                margin-right: 70px;
            }

            .label {
                padding: 2px !important;
            }

            #machine_actions paper-button {
                text-align: left !important;
            }
            .machine-state-icon {
                background-color: #fff !important;
            }
            .machine-state-icon.running {
                color: var(--green-color) !important;
            }

            .machine-state-icon.terminated {
                color: var(--mist-dark-color) !important;;
            }

            .machine-state-icon.stopped {
                color: var(--orange-color) !important;;
            }

            .machine-state-icon.error {
                color: var(--red-color) !important;;
            }
            .smallcaps {
                margin-top: 0;
            }
            .tag {
                padding: 4px;
            }
        </style>
       
        <div id="content">
            <paper-material class="single-head layout horizontal" style$="background-color: [[section.color]]"> 
                <span class="icon"><iron-icon class$=" machine-state-icon [[machine.state]]" icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        [[machine.name]]
                    </h2>
                    <div class="subtitle">
                        [[machine.state]] <span class="status" hidden$="[[isState(machine)]]">[[machine.extra.status]]</span>
                    </div>
                </div>
                <div class="item-actions">
                <!-- can_destroy:true
                    can_start:false
                    can_stop:true
                    can_suspend:false
                    can_reboot:true
                    can_rename:true
                    can_resume:false
                    can_tag:true
                    can_undefine:false -->                    
                    <paper-button on-tap="restart" class="simple" hidden$="[[!machine.can_start]]">start</paper-button>
                    <paper-button on-tap="stop" class="simple" hidden$="[[!machine.can_stop]]">stop</paper-button>
                    <paper-button on-tap="reboot" class="simple" hidden$="[[!machine.can_reboot]]">reboot</paper-button>                    
                    <paper-menu-button>
                        <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
                        <paper-menu id="machine_actions" class="dropdown-content">
                            <paper-button on-tap="suspend" class="simple" hidden$="[[!machine.can_suspend]]">suspend</paper-button>
                            <paper-button on-tap="destroy" class="simple" hidden$="[[!machine.can_destroy]]">destroy</paper-button>
                            <paper-button on-tap="rename" class="simple" hidden$="[[!machine.can_rename]]">rename</paper-button>
                            <paper-button on-tap="tag" class="simple" hidden$="[[!machine.can_tag]]">tag</paper-button>
                            <paper-button on-tap="undefine" class="simple" hidden$="[[!machine.can_undefine]]">undefine</paper-button>
                        </paper-menu>
                    </paper-menu-button>
                    <paper-button on-tap="ssh" class="simple white" style$="color: [[section.color]]"><iron-icon style$="color: [[section.color]]" icon="icons:code"></iron-icon> ssh</paper-button>
                    <paper-button on-tap="monitor" class="simple white" style$="color: [[section.color]]">monitor <iron-icon style$="color: [[section.color]]" icon="icons:visibility"></iron-icon></paper-button>
                </div>
            </paper-material>
            <div class="columns">
                <div id="leftcolumn" class="left">                    
                    <paper-material>
                        <h3 class="smallcaps">Info:</h3>
                        <span hidden$="[[!machine.cloud.title]]">Cloud: [[machine.cloud.title]]</span>
                        <span hidden$="[[!machine.extra.image]]">, Image: [[machine.extra.image]]</span>
                        <span hidden$="[[!machine.extra.created]]">, Created: [[machine.extra.created]]</span>
                    </paper-material>
                </div>
                <div id="rightcolumn" class="right" hidden$="[[!machine.tags.length]]">
                    <paper-material>
                        <h3 class="smallcaps">TAGS:</h3>
                        <template is="dom-repeat" items="[[machine.tags]]">
                            <span class="tag">[[item.key]] <span hidden$="[[!item.value]]">=</span> [[item.value]]</span>
                        </template>
                    </paper-material>
                </div>
            </div>            
            <paper-material class="info-card">
                <h2 style$="[[_getHeaderStyle(section.color)]]" on-tap="toggle">Basic Info</h2>
                <div class="card-content">
                    <table class="info-table">
                        <template is="dom-if" if="[[machine.public_ips]]">
                            <tr>
                                <td>
                                    Public IPs
                                </td>
                                <td>
                                    <template is="dom-repeat" items="[[machine.public_ips]]">
                                        <p class="machine-ip">[[item]]</p>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </table>
                </div>
            </paper-material>
        </div>
        <div class="absolute-bottom-right">
            <app-fab></app-fab>
        </div>
        <dialog-element></dialog-element>
        <iron-ajax id="machineDeleteAjaxRequest" url="/api/v1/machines/[[machine.id]]" method="DELETE" on-response="_handleMachineDeleteAjaxResponse" on-error="_handleMachineDeleteAjaxError"></iron-ajax>
        <machine-edit machine="[[machine]]"></machine-edit>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'machine-page',

        properties: {
            model: {
                type: Object,
                notify: true
            },
            router: Object,
            params: {
                type: Object,
                notify: true
            },
            machine: {
                type: Object,
                computed: '_computeMachine(params, model.machinesArray.*)'
            },
            sections: {
                type: Array,
                notify: true
            },
            section: {
                type: Object
            },
            tag: {
                type: String,
                value: ""
            },
            machineImage: {
                type: String,
                computed: "_machineImage(machine.imageId)"
            }
        },
        listeners: {
            'confirmation': '_deleteMachineEventResponse'
        },    
        _computeMachine: function(params, machines) {
            return machines.base.find(function(machine) {
                return machine.uuid == params.uuid;
            }, this);
        },
        _isEqual: function(a, b) {
            return a === b;
        },
        _getColor: function() {
            return this.section && this.section.color ? this.section.color : '';
        },
        addKey: function(_, params) {
            console.log("clicked addKey");
        },
        rename: function(_, params) {
            console.log("clicked rename");
        },
        restart: function(_, params) {
            console.log("clicked restart");
        },
        shutdown: function(_, params) {
            console.log("clicked shutdown");
        },
        destroy: function(_, params) {
            console.log("clicked destroy");
        },
        _getHeaderStyle: function(color) {
            return 'background-color: ' + color + '; color: #fff;';
        },
        toggle: function() {
            this.$.collapse.toggle();
        },
        togglefull: function() {
            this.$.collapsefull.toggle();
        },
        _machineImage: function(id) {
            var image = this.model.imagesArray.find(function(image) {
                return image.id == id;
            }, this);
            if (image)
                return image.name;
            else
                return "";
        },
        _editMachineTags: function() {
            var url = '/machines/' + this.machine.uuid + '/tags';
            page.show(url);
        },
        _editMachine: function(e) {
            var el = this.querySelector('machine-edit');
            el._openEditMachineModal();
        },
        _deleteMachine: function(e) {
            this._showDialog({
                title: 'Delete Machine?',
                body: "Deleting a machine can not be undone. You are about to delete machine '" + this.machine.name + "'.",
                danger: true,
                reason: "machine.delete"
            });
        },
        _deleteMachineEventResponse: function(e) {
            var reason = e.detail.reason,
                response = e.detail.response;

            if (response.confirmed && reason == "machine.delete") {
                this.$.machineDeleteAjaxRequest.body = {};
                this.$.machineDeleteAjaxRequest.headers["Content-Type"] = 'application/json';
                this.$.machineDeleteAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.machineDeleteAjaxRequest.generateRequest();
            }
        },
        _handleMachineDeleteAjaxResponse: function(e) {
            page.show('/machines');
        },
        _showDialog: function(info) {
            var dialog = this.querySelector('dialog-element');
            for (var i in info) {
                dialog[i] = info[i];
            }
            dialog._openDialog();
        },
        _goBack: function() {
            history.back();
        },
        isState: function(machine){
            return machine.state == machine.extra.status ;
        },
    });
</script>
