<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../app-rules/app-rules.html">
<link rel="import" href="machine-edit.html">
<link rel="import" href="machine-tag-item.html">
<dom-module id="machine-tags">
    <template>
        <style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="info-table-style"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
            :host {
                display: block;
                background: #fafafa;
            }

            #content {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
                padding: 20px;
            }

            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
                align-content: stretch;
                flex: 100%;
            }

            .flexchild {
                @apply(--layout-flex);
            }

            .paper-header h2 {
                @apply(--layout-flex-none);
            }

            .machine-ip {
                margin: 0;
            }

            paper-material > h2 {
                line-height: initial !important;
                margin-bottom: 0;
                cursor: pointer;
            }

            .subhead {
                box-sizing: border-box;
                position: absolute;
                width: 100%;
                left: 0;
                height: 57px;
                bottom: -57px;
                right: 0;
                z-index: 9;
                color: rgba(0, 0, 0, 0.87);
            }

            .content {
                margin-top: 57px;
            }

            paper-header-panel::content #dropShadow {
                top: 56px;
            }

            paper-toolbar::content #bottomBar .right-actions {
                transition: var(--paper-toolbar-transition, margin-right 0.18s ease-in);
            }

            paper-toolbar:not(.tall)::content #bottomBar .right-actions {
                margin-right: 70px;
            }

            .label {
                padding: 2px !important;
            }
        </style>
        <paper-drawer-panel id="drawerPanel" responsive-width="900px" narrow="{{narrowMode}}" drawer-width="272px" disable-edge-swipe>
            <app-sidebar tag="[[tag]]" sections="[[sections]]" current="machines" drawer></app-sidebar>
            <paper-header-panel id="container" mode="waterfall-tall" main>
                <paper-toolbar class="tall" style$="[[_getHeaderStyle(section.color)]]">
                    <paper-icon-button icon="icons:arrow-back" on-tap="_goBack"></paper-icon-button>
                    <span class="title"></span>
                    <app-user-menu email="[[model.email]]"></app-user-menu>
                    <span class="bottom title">Machine: [[machine.name]]</span>
                    <span class="bottom right-actions">
                        <template is="dom-if" if="[[machine.can_rename]]">
                            <paper-tooltip for="editMachine" position="top">Rename Machine</paper-tooltip>
                            <paper-icon-button id="editMachine" icon="icons:create" on-tap="_editMachine"></paper-icon-button>
                        </template>
                        <template is="dom-if" if="[[machine.can_destroy]]">
                            <paper-tooltip for="deleteMachine" position="top">Delete Machine</paper-tooltip>
                            <paper-icon-button id="deleteMachine" icon="icons:delete" on-tap="_deleteMachine"></paper-icon-button>
                        </template>
                    </span>
                    <div class="subhead bottom">
                        <div class="label">
                            <span class$="[[machine.state]]" title="machine state">[[machine.state]]</span>
                        </div>
                    </div>
                </paper-toolbar>
                <div class="content">
                    <div class="page">
                        <paper-material class="info-card">
                            <h2>Tags</h2>
                            <div class="card-content">
                                <table class="info-table">
                                    <template is="dom-repeat" items="[[editableTags]]" as="tag">
                                        <machine-tag-item tag="[[tag]]"></machine-tag-item>
                                    </template>
                                </table>

                                <div class="clearfix bottom-actions xs12">
                                    <paper-button class="submit-btn pull-left" raised on-tap="_saveTags">Save Tags</paper-button>
                                    <paper-button class="submit-btn pull-right" raised on-tap="_addTag">Add Tag</paper-button>
                                </div>
                            </div>
                        </paper-material>
                    </div>
                </div>
                <div class="absolute-bottom-right">
                    <app-fab></app-fab>
                </div>
            </paper-header-panel>
        </paper-drawer-panel>
        <dialog-element></dialog-element>
        <iron-ajax id="machineDeleteAjaxRequest" url="/api/v1/machines/[[machine.id]]" method="DELETE" on-response="_handleMachineDeleteAjaxResponse" on-error="_handleMachineDeleteAjaxError"></iron-ajax>
        <iron-ajax id="machineTagsAjaxRequest" url="/api/v1/clouds/[[machine.cloud.id]]/machines/[[machine.id]]/tags" method="POST" on-response="_handleMachineTagsAjaxResponse" on-error="_handleMachineTagsAjaxError"></iron-ajax>
        <machine-edit machine="[[machine]]"></machine-edit>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'machine-tags',

        properties: {
            model: {
                type: Object,
                notify: true
            },
            router: Object,
            params: {
                type: Object,
                notify: true
            },
            machine: {
                type: Object,
                computed: '_computeMachine(params, model.machinesArray.*)'
            },
            sections: {
                type: Array,
                notify: true
            },
            section: {
                type: Object
            },
            tag: {
                type: String,
                value: ""
            },
            editableTags: {
                type: Array,
                computed: '_computeEditableTags(machine.tags.*)'
            }
        },
        _computeMachine: function(params, machines) {
            return machines.base.find(function(machine) {
                return machine.uuid == params.uuid;
            }, this);
        },
        _computeEditableTags: function(tags) {
            if (!tags.base.length) {
                return [{
                    key: '',
                    value: ''
                }];
            }

            return tags.base.slice();
        },
        _getHeaderStyle: function(color) {
            return 'background-color: ' + color + '; color: #fff;';
        },
        _editMachine: function(e) {
            var el = this.querySelector('machine-edit');
            el._openEditMachineModal();
        },
        _deleteMachine: function(e) {
            this._showDialog({
                title: 'Delete Machine?',
                body: "Deleting a machine can not be undone. You are about to delete machine '" + this.machine.name + "'.",
                danger: true,
                reason: "machine.delete"
            });
        },
        _deleteMachineEventResponse: function(e) {
            var reason = e.detail.reason,
                response = e.detail.response;

            if (response.confirmed && reason == "machine.delete") {
                this.$.machineDeleteAjaxRequest.body = {};
                this.$.machineDeleteAjaxRequest.headers["Content-Type"] = 'application/json';
                this.$.machineDeleteAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.machineDeleteAjaxRequest.generateRequest();
            }
        },
        _handleMachineDeleteAjaxResponse: function(e) {
            page.show('/machines');
        },
        _showDialog: function(info) {
            var dialog = this.querySelector('dialog-element');
            for (var i in info) {
                dialog[i] = info[i];
            }
            dialog._openDialog();
        },
        _addTag: function() {
            var newTag = {
                key: '',
                value: ''
            };
            this.push('editableTags', newTag);
        },
        _saveTags: function() {
            var tags = this.editableTags.filter(function(tag) {
                return tag.key && tag.value;
            }), payloadTags = {};

            if (tags.length) {
                this.set('machine.tags', tags);
                tags.forEach(function(tag) {
                    payloadTags[tag.key] = tag.value;
                });

                this.$.machineTagsAjaxRequest.body = {
                    tags: payloadTags
                };
                this.$.machineTagsAjaxRequest.headers["Content-Type"] = 'application/json';
                this.$.machineTagsAjaxRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.machineTagsAjaxRequest.generateRequest();
            }
        },
        _handleMachineTagsAjaxResponse: function(e) {
            console.log(e);
        },
        _goBack: function() {
            history.back();
        }
    });
</script>
